# WebSocket å®æ—¶æ¨é€è°ƒè¯•æŒ‡å—

## é—®é¢˜ï¼šè¿è¡Œ test-websocket-push.js åå¤§å±æ²¡æœ‰å˜åŒ–

### æ’æŸ¥æ­¥éª¤

#### 1. æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ
```bash
# ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ
cd backend
npm start
```

**é¢„æœŸè¾“å‡ºï¼š**
```
âœ… WebSocket æœåŠ¡å·²å¯åŠ¨ (è·¯å¾„: /ws)
ğŸš€ é€ å£æŠ¤ç†ç³»ç»Ÿåç«¯æœåŠ¡å·²å¯åŠ¨
```

#### 2. æ£€æŸ¥ WebSocket è¿æ¥çŠ¶æ€

**åœ¨æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰æ£€æŸ¥ï¼š**
```javascript
// æ£€æŸ¥ WebSocket è¿æ¥çŠ¶æ€
console.log('WebSocket çŠ¶æ€:', wsClient.ws?.readyState);
// 0 = CONNECTING
// 1 = OPEN
// 2 = CLOSING
// 3 = CLOSED
```

**é¢„æœŸï¼š** `readyState` åº”è¯¥æ˜¯ `1` (OPEN)

#### 3. è¿è¡Œæµ‹è¯•è„šæœ¬å¹¶è§‚å¯Ÿæ—¥å¿—

```bash
cd backend
node test-websocket-push.js
```

**æ£€æŸ¥æµ‹è¯•è„šæœ¬è¾“å‡ºï¼š**

åº”è¯¥çœ‹åˆ°ï¼š
- `âœ… æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ (http://localhost:3000)`
- `ğŸ“Š æœåŠ¡å™¨ç«¯äº‹ä»¶ç›‘å¬å™¨çŠ¶æ€ï¼š` (æ˜¾ç¤ºç›‘å¬å™¨æ•°é‡)
- `âœ… API è°ƒç”¨æˆåŠŸ:` (æ¯ä¸ªæµ‹è¯•)

**å¦‚æœçœ‹åˆ° 403 é”™è¯¯ï¼š**
- æµ‹è¯•è·¯ç”±è¢«ç¦ç”¨ï¼Œæ£€æŸ¥ NODE_ENV ç¯å¢ƒå˜é‡
- æŸ¥çœ‹æœåŠ¡å™¨å¯åŠ¨æ—¥å¿—ä¸­çš„ `[TestRoutes]` æ—¥å¿—

**å¦‚æœçœ‹åˆ° 404 é”™è¯¯ï¼š**
- æµ‹è¯•è·¯ç”±æœªæ³¨å†Œï¼Œéœ€è¦é‡å¯æœåŠ¡å™¨
- æ£€æŸ¥æœåŠ¡å™¨å¯åŠ¨æ—¥å¿—ä¸­æ˜¯å¦æœ‰ "æµ‹è¯•è·¯ç”±å·²å¯ç”¨" æ¶ˆæ¯

**æ£€æŸ¥åç«¯æ§åˆ¶å°è¾“å‡ºï¼š**

åº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼š
- `ğŸ§ª [Test API] è§¦å‘è¯„ä¼°åˆ›å»ºäº‹ä»¶`
- `[EventEmitter] ğŸ“ è§¦å‘è¯„ä¼°åˆ›å»ºäº‹ä»¶`
- `ğŸ“ [Server] æ–°è¯„ä¼°åˆ›å»ºï¼Œæ¨é€é€šçŸ¥...`
- `ğŸ“¢ å¹¿æ’­æ¶ˆæ¯: new_assessment (å‘é€ç»™ X ä¸ªå®¢æˆ·ç«¯)`
- `ğŸš¨ [Server] é«˜å±æ‚£è€…è­¦æŠ¥ï¼Œæ¨é€é€šçŸ¥...`
- `ğŸ“¢ å¹¿æ’­æ¶ˆæ¯: high_risk_alert (å‘é€ç»™ X ä¸ªå®¢æˆ·ç«¯)`
- `ğŸ“Š [Server] Dashboard æ•°æ®å˜æ›´ï¼Œæ¨é€æ›´æ–°...`
- `ğŸ“¢ å¹¿æ’­æ¶ˆæ¯: dashboard_update (å‘é€ç»™ X ä¸ªå®¢æˆ·ç«¯)`

**å¦‚æœçœ‹åˆ° "å‘é€ç»™ 0 ä¸ªå®¢æˆ·ç«¯"ï¼š**
- è¯´æ˜æ²¡æœ‰å®¢æˆ·ç«¯è¿æ¥
- æ£€æŸ¥å‰ç«¯ WebSocket æ˜¯å¦è¿æ¥æˆåŠŸ

**å¦‚æœæ²¡æœ‰ä»»ä½•æ—¥å¿—ï¼š**
- æ£€æŸ¥äº‹ä»¶å‘å°„å™¨æ˜¯å¦æ­£ç¡®å·¥ä½œ
- æ£€æŸ¥ `server.js` ä¸­çš„äº‹ä»¶ç›‘å¬å™¨æ˜¯å¦æ³¨å†Œ
- æ£€æŸ¥æµ‹è¯•è·¯ç”±æ˜¯å¦æ­£å¸¸å·¥ä½œï¼ˆæŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼‰

#### 4. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°

**åº”è¯¥çœ‹åˆ°ï¼š**
```
ğŸ“¡ æ­£åœ¨è¿æ¥ WebSocket... ws://localhost:3000/ws?token=...
âœ… WebSocket å·²è¿æ¥
ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: connection
ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: dashboard_update
ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: new_assessment
ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: high_risk_alert
```

**å¦‚æœæ²¡æœ‰çœ‹åˆ° "æ”¶åˆ°æ¶ˆæ¯"ï¼š**
- WebSocket è¿æ¥å¯èƒ½å¤±è´¥
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- æ£€æŸ¥ WebSocket URL æ˜¯å¦æ­£ç¡®

#### 5. æ‰‹åŠ¨æµ‹è¯• WebSocket è¿æ¥

åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œï¼š
```javascript
// æ‰‹åŠ¨æµ‹è¯• WebSocket
const ws = new WebSocket('ws://localhost:3000/ws');
ws.onopen = () => console.log('âœ… WebSocket è¿æ¥æˆåŠŸ');
ws.onmessage = (e) => console.log('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯:', JSON.parse(e.data));
ws.onerror = (e) => console.error('âŒ WebSocket é”™è¯¯:', e);
```

#### 6. æ£€æŸ¥é…ç½®æ–‡ä»¶

ç¡®ä¿ `config.dev.js` æˆ– `config.prod.js` ä¸­ï¼š
- `apiBaseUrl` æ­£ç¡®
- `enableWebSocket` ä¸ä¸º `false`ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

#### 7. å¸¸è§é—®é¢˜

**é—®é¢˜ 1ï¼šæµ‹è¯• API è¿”å› 403 æˆ– 404**

**ç—‡çŠ¶ï¼š** è¿è¡Œ `test-websocket-push.js` æ—¶ï¼Œæ‰€æœ‰ API è°ƒç”¨è¿”å› 403 æˆ– 404

**åŸå› ï¼š**
- 404ï¼šæµ‹è¯•è·¯ç”±æœªæ³¨å†Œï¼ˆéœ€è¦é‡å¯æœåŠ¡å™¨ï¼‰
- 403ï¼šæµ‹è¯•è·¯ç”±è¢«ç¦ç”¨ï¼ˆNODE_ENV è®¾ç½®ä¸º 'production'ï¼‰

**è§£å†³æ–¹æ¡ˆï¼š**

1. **æ£€æŸ¥æœåŠ¡å™¨å¯åŠ¨æ—¥å¿—ï¼š**
   ```
   [Server] å½“å‰ç¯å¢ƒ: NODE_ENV = "development"
   [TestRoutes] ç¯å¢ƒå˜é‡ NODE_ENV = "development"
   âœ… æµ‹è¯•è·¯ç”±å·²å¯ç”¨ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
   ```

2. **å¦‚æœçœ‹åˆ° "æµ‹è¯•è·¯ç”±å·²ç¦ç”¨ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰"ï¼š**
   - æ–¹æ³• 1ï¼šè®¾ç½®ç¯å¢ƒå˜é‡ä¸ºå¼€å‘ç¯å¢ƒ
     ```bash
     # Windows PowerShell
     $env:NODE_ENV="development"
     npm start
     
     # Windows CMD
     set NODE_ENV=development
     npm start
     
     # Linux/Mac
     export NODE_ENV=development
     npm start
     ```
   
   - æ–¹æ³• 2ï¼šå¼ºåˆ¶å¯ç”¨æµ‹è¯•è·¯ç”±
     ```bash
     # Windows PowerShell
     $env:ENABLE_TEST_ROUTES="true"
     npm start
     
     # Linux/Mac
     export ENABLE_TEST_ROUTES=true
     npm start
     ```

3. **å¦‚æœçœ‹åˆ° 404ï¼š**
   - ç¡®ä¿æœåŠ¡å™¨å·²é‡å¯
   - æ£€æŸ¥ `backend/src/routes/index.js` ä¸­æ˜¯å¦åŒ…å«æµ‹è¯•è·¯ç”±
   - æ£€æŸ¥ `backend/src/routes/testRoutes.js` æ–‡ä»¶æ˜¯å¦å­˜åœ¨

**é—®é¢˜ 2ï¼šWebSocket è¿æ¥å¤±è´¥**
- æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ
- æ£€æŸ¥ç«¯å£æ˜¯å¦æ­£ç¡®ï¼ˆé»˜è®¤ 3000ï¼‰
- æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

**é—®é¢˜ 3ï¼šè¿æ¥æˆåŠŸä½†æ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯**
- æ£€æŸ¥åç«¯æ§åˆ¶å°æ˜¯å¦æœ‰ "ğŸ“¢ å¹¿æ’­æ¶ˆæ¯" æ—¥å¿—
- æ£€æŸ¥ `clients.size` æ˜¯å¦å¤§äº 0
- è¿è¡Œ `websocketService.getStats()` æŸ¥çœ‹è¿æ¥æ•°

**é—®é¢˜ 4ï¼šæ”¶åˆ°æ¶ˆæ¯ä½†å¤§å±ä¸æ›´æ–°**
- æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰ JavaScript é”™è¯¯
- æ£€æŸ¥ `loadDashboardData()` å’Œ `loadDETStageStats()` æ˜¯å¦è¢«è°ƒç”¨
- æ£€æŸ¥ API è¯·æ±‚æ˜¯å¦æˆåŠŸ

#### 8. è°ƒè¯•å‘½ä»¤

**åœ¨åç«¯æ§åˆ¶å°ï¼ˆNode.js REPLï¼‰ï¼š**
```javascript
// æŸ¥çœ‹ WebSocket è¿æ¥ç»Ÿè®¡
const websocketService = require('./src/services/websocketService');
console.log(websocketService.getStats());

// æ‰‹åŠ¨è§¦å‘äº‹ä»¶
const dataEmitter = require('./src/utils/eventEmitter');
dataEmitter.emit(dataEmitter.EVENTS.DASHBOARD_REFRESH, { type: 'test' });
```

**åœ¨å‰ç«¯æµè§ˆå™¨æ§åˆ¶å°ï¼š**
```javascript
// æ£€æŸ¥ WebSocket å®¢æˆ·ç«¯çŠ¶æ€
console.log('WebSocket:', wsClient.ws);
console.log('è¿æ¥çŠ¶æ€:', wsClient.ws?.readyState);
console.log('é‡è¿æ¬¡æ•°:', wsClient.reconnectAttempts);

// æ‰‹åŠ¨è§¦å‘æ•°æ®åˆ·æ–°
loadDashboardData();
loadDETStageStats();
```

### ä¿®å¤åçš„æ”¹è¿›

1. âœ… `emitHighRiskAlert` ç°åœ¨æ”¯æŒå¯¹è±¡å‚æ•°
2. âœ… æ·»åŠ äº†è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
3. âœ… ç»Ÿä¸€äº†äº‹ä»¶æ•°æ®æ ¼å¼
4. âœ… æ”¹è¿›äº†é”™è¯¯å¤„ç†

### æµ‹è¯•æ­¥éª¤

1. å¯åŠ¨åç«¯æœåŠ¡ï¼š`cd backend && npm start`
2. æ‰“å¼€å¤§å±é¡µé¢ï¼š`http://localhost:3000`
3. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰
4. è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š`node backend/test-websocket-push.js`
5. è§‚å¯Ÿï¼š
   - åç«¯æ§åˆ¶å°æ—¥å¿—
   - æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—
   - å¤§å±æ•°æ®æ˜¯å¦æ›´æ–°
   - æ˜¯å¦å¼¹å‡ºè­¦æŠ¥æ¡†

### é¢„æœŸç»“æœ

- âœ… åç«¯æ§åˆ¶å°æ˜¾ç¤ºäº‹ä»¶è§¦å‘å’Œå¹¿æ’­æ—¥å¿—
- âœ… æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤ºæ”¶åˆ° WebSocket æ¶ˆæ¯
- âœ… å¤§å±æ•°æ®è‡ªåŠ¨åˆ·æ–°
- âœ… é«˜å±è­¦æŠ¥æ—¶å¼¹å‡ºçº¢è‰²æç¤ºæ¡†


<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§é€ å£æŠ¤ç†ä¸´åºŠå†³ç­–æ”¯æŒç³»ç»Ÿ - å®æ—¶æ•°æ®å¯è§†åŒ–å¹³å°</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- é…ç½®æ–‡ä»¶ï¼šå¼€å‘ç¯å¢ƒç”¨config.dev.jsï¼Œç”Ÿäº§ç¯å¢ƒç”¨config.prod.js -->
    <!-- âš ï¸ é‡è¦ï¼šè¯·ç¡®ä¿åŠ è½½æ­£ç¡®çš„é…ç½®æ–‡ä»¶ï¼ -->
    <script src="config.prod.js"></script>
    <style>
        :root{
            --bg-deep:#0a1628;
            --primary-50:#dbeafe;
            --primary-100:#bfdbfe;
            --primary-200:#93c5fd;
            --primary-300:#60a5fa;
            --primary-400:#3b82f6;
            --primary-500:#2563eb;
            --accent-cyan:#22d3ee;
            --success:#34d399;
            --warning:#f59e0b;
            --danger:#ef4444;
            --muted:#64748b;
            --text:#ffffff;
            --text-soft:#e0f2fe;
            --glow:rgba(59,130,246,0.35);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', Arial, sans-serif;
            background: var(--bg-deep);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
            position: relative;
        }

        /* åŠ¨æ€èƒŒæ™¯ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(96, 165, 250, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(147, 197, 253, 0.1) 0%, transparent 70%);
            animation: backgroundPulse 15s ease-in-out infinite;
            z-index: 0;
        }

        @keyframes backgroundPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* ç²’å­æ•ˆæœå®¹å™¨ */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: float linear infinite;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(1);
                opacity: 0;
            }
        }

        .dashboard-container {
            width: 100%;
            height: 100vh;
            padding: 1vh 1vw;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
        }

        /* å¤´éƒ¨ */
        .dashboard-header {
            text-align: center;
            margin-bottom: 1vh;
            padding: 1vh 2vw;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(96, 165, 250, 0.1));
            backdrop-filter: blur(20px);
            border-radius: 15px;
            border: 1px solid rgba(96, 165, 250, 0.3);
            box-shadow: 
                0 8px 32px var(--glow),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            animation: headerGlow 3s ease-in-out infinite;
        }

        @keyframes headerGlow {
            0%, 100% {
                box-shadow: 
                    0 8px 32px var(--glow),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
            }
            50% {
                box-shadow: 
                    0 8px 40px rgba(59, 130, 246, 0.45),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
            }
        }

        .dashboard-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            animation: headerShine 3s linear infinite;
        }

        @keyframes headerShine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .dashboard-header h1 {
            font-size: clamp(1.3rem, 2.5vw, 2rem);
            font-weight: 700;
            text-shadow: 
                0 0 10px rgba(59, 130, 246, 0.8),
                0 0 20px rgba(96, 165, 250, 0.6),
                2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 0.3vh;
            position: relative;
            z-index: 1;
            background: linear-gradient(135deg, #fff, var(--primary-300), #fff);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .dashboard-header .subtitle {
            font-size: clamp(0.75rem, 1.3vw, 1rem);
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .dashboard-header .update-time {
            font-size: clamp(0.65rem, 1.1vw, 0.85rem);
            opacity: 0.7;
            position: absolute;
            top: 50%;
            right: 30px;
            transform: translateY(-50%);
            z-index: 1;
            color: #60a5fa;
            animation: blink 2s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        /* ä¸»ä½“å†…å®¹ */
        .dashboard-body {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 1vw;
            min-height: 0;
            overflow: hidden;
        }

        /* å·¦ä¾§æ  */
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 1vh;
            min-height: 0;
        }

        /* ä¸­é—´æ  */
        .middle-column {
            display: flex;
            flex-direction: column;
            gap: 1vh;
            min-height: 0;
        }

        /* å³ä¾§æ  */
        .right-column {
            display: flex;
            flex-direction: column;
            gap: 1vh;
            min-height: 0;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: linear-gradient(135deg, rgba(30, 64, 175, 0.15), rgba(37, 99, 235, 0.08));
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 1vh 1vw;
            border: 1px solid rgba(96, 165, 250, 0.2);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            transition: left 0.6s;
        }

        .card:hover::before {
            left: 100%;
        }

        .card:hover {
            border-color: rgba(96, 165, 250, 0.5);
            box-shadow: 
                0 12px 40px rgba(59, 130, 246, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .card-title {
            font-size: clamp(1rem, 1.8vw, 1.3rem);
            font-weight: 600;
            margin-bottom: 0.8vh;
            padding-bottom: 0.5vh;
            border-bottom: 2px solid rgba(96, 165, 250, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            flex-shrink: 0;
        }

        .card-title::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-400), var(--primary-300));
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.8);
            animation: titleGlow 2s ease-in-out infinite;
        }

        @keyframes titleGlow {
            0%, 100% {
                box-shadow: 0 0 10px rgba(59, 130, 246, 0.8);
                width: 60px;
            }
            50% {
                box-shadow: 0 0 20px rgba(59, 130, 246, 1);
                width: 80px;
            }
        }

        .card-title .icon {
            font-size: clamp(1.2rem, 2vw, 1.5rem);
            filter: drop-shadow(0 0 5px rgba(96, 165, 250, 0.8));
            animation: iconPulse 2s ease-in-out infinite;
        }

        @keyframes iconPulse {
            0%, 100% {
                transform: scale(1);
                filter: drop-shadow(0 0 5px rgba(96, 165, 250, 0.8));
            }
            50% {
                transform: scale(1.1);
                filter: drop-shadow(0 0 10px rgba(96, 165, 250, 1));
            }
        }

        /* ç»Ÿè®¡å¡ç‰‡ç½‘æ ¼ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.8vw;
            flex-shrink: 0;
        }

        .stat-item {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.1));
            padding: 1vh 0.8vw;
            border-radius: 12px;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(96, 165, 250, 0.2);
            position: relative;
            overflow: hidden;
        }

        .stat-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(59, 130, 246, 0.3), transparent 70%);
            opacity: 0;
            transition: opacity 0.4s;
        }

        .stat-item:hover::before {
            opacity: 1;
        }

        .stat-item:hover {
            transform: translateY(-5px) scale(1.02);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(37, 99, 235, 0.15));
            border-color: rgba(96, 165, 250, 0.5);
            box-shadow: 
                0 10px 30px rgba(59, 130, 246, 0.4),
                inset 0 0 20px rgba(59, 130, 246, 0.1);
        }

        .stat-value {
            font-size: clamp(1.8rem, 3.5vw, 2.8rem);
            font-weight: 700;
            margin-bottom: 0.5vh;
            background: linear-gradient(135deg, #fff, var(--primary-300), var(--primary-200));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: numberGlow 3s ease-in-out infinite;
            text-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
            position: relative;
            z-index: 1;
            filter: drop-shadow(0 0 10px rgba(96, 165, 250, 0.8));
        }

        @keyframes numberGlow {
            0%, 100% {
                background-position: 0% 50%;
                filter: drop-shadow(0 0 10px rgba(96, 165, 250, 0.8));
            }
            50% {
                background-position: 100% 50%;
                filter: drop-shadow(0 0 20px rgba(59, 130, 246, 1));
            }
        }

        .stat-label {
            font-size: clamp(0.75rem, 1.2vw, 0.9rem);
            opacity: 0.9;
            position: relative;
            z-index: 1;
            color: #e0f2fe;
        }

        .stat-change {
            font-size: clamp(0.7rem, 1vw, 0.8rem);
            margin-top: 0.5vh;
            opacity: 0.8;
            position: relative;
            z-index: 1;
        }

        .stat-change.positive {
            color: #4ade80;
            text-shadow: 0 0 5px rgba(74, 222, 128, 0.5);
        }

        .stat-change.negative {
            color: #f87171;
            text-shadow: 0 0 5px rgba(248, 113, 113, 0.5);
        }

        /* å›¾è¡¨å®¹å™¨ */
        .chart-container {
            flex: 1;
            margin-top: 0.5vh;
            min-height: 220px;
            max-height: 35vh;
        }

        .chart-container-large {
            flex: 1;
            margin-top: 0.5vh;
            min-height: 300px;
            max-height: 48vh;
        }

        /* ç‚«é…·è¾¹æ¡†ï¼šDETç»´åº¦åˆ†æï¼ˆçº¢æ¡†å¤„ï¼‰ */
        #stageChart {
            position: relative;
            border-radius: 14px;
            box-shadow:
                inset 0 0 0 1px rgba(96, 165, 250, 0.15),
                0 0 28px var(--glow);
            overflow: hidden;
        }
        #stageChart::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: radial-gradient(60% 60% at 50% 50%, rgba(96,165,250,0.25), transparent 60%),
                        conic-gradient(from 0deg, rgba(59,130,246,0.25), rgba(34,211,238,0.18), rgba(59,130,246,0.25));
            filter: blur(14px);
            animation: neonRotate 8s linear infinite;
            z-index: 0;
            pointer-events: none;
        }
        #stageChart::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 14px;
            box-shadow: 0 0 0 2px rgba(59,130,246,0.15) inset;
            animation: neonPulse 3.2s ease-in-out infinite;
            z-index: 0;
            pointer-events: none;
        }
        @keyframes neonRotate {
            to { transform: rotate(360deg); }
        }
        @keyframes neonPulse {
            0%, 100% { box-shadow: 0 0 0 2px rgba(59,130,246,0.15) inset, 0 0 24px rgba(59,130,246,0.15); }
            50%      { box-shadow: 0 0 0 2px rgba(147,197,253,0.3) inset, 0 0 36px rgba(59,130,246,0.35); }
        }

        /* åˆ—è¡¨æ ·å¼ */
        .data-list {
            flex: 1;
            overflow-y: auto;
            min-height: 150px;
        }

        /* è‡ªåŠ¨æ»šåŠ¨åˆ—è¡¨æ ·å¼ */
        .data-list.auto-scroll {
            overflow: hidden;
            position: relative;
            mask-image: linear-gradient(to bottom, 
                transparent 0%, 
                black 5%, 
                black 95%, 
                transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, 
                transparent 0%, 
                black 5%, 
                black 95%, 
                transparent 100%);
        }

        .data-list.auto-scroll .scroll-content {
            animation: autoScroll 30s linear infinite;
            will-change: transform;
        }

        .data-list.auto-scroll:hover .scroll-content {
            animation-play-state: paused;
        }

        @keyframes autoScroll {
            0% {
                transform: translateY(0);
            }
            100% {
                transform: translateY(-50%);
            }
        }

        .data-list::-webkit-scrollbar {
            width: 8px;
        }

        .data-list::-webkit-scrollbar-track {
            background: rgba(59, 130, 246, 0.1);
            border-radius: 4px;
        }

        .data-list::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(59, 130, 246, 0.5), rgba(96, 165, 250, 0.5));
            border-radius: 4px;
            box-shadow: 0 0 6px rgba(59, 130, 246, 0.5);
        }

        .data-list::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(59, 130, 246, 0.7), rgba(96, 165, 250, 0.7));
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.8);
        }

        .list-item {
            padding: 0.8vh 0.8vw;
            margin-bottom: 0.8vh;
            background: linear-gradient(135deg, rgba(30, 64, 175, 0.2), rgba(37, 99, 235, 0.1));
            border-radius: 10px;
            border-left: 3px solid transparent;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .list-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.2), transparent);
            transition: left 0.5s;
        }

        .list-item:hover::before {
            left: 100%;
        }

        .list-item:hover {
            background: linear-gradient(135deg, rgba(30, 64, 175, 0.3), rgba(37, 99, 235, 0.15));
            transform: translateX(8px) scale(1.02);
            box-shadow: 
                -4px 0 15px rgba(59, 130, 246, 0.3),
                0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .list-item.high-risk {
            border-left-color: #ef4444;
        }

        .list-item.high-risk:hover {
            box-shadow: 
                -4px 0 15px rgba(239, 68, 68, 0.5),
                0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .list-item.medium-risk {
            border-left-color: #f59e0b;
        }

        .list-item.medium-risk:hover {
            box-shadow: 
                -4px 0 15px rgba(245, 158, 11, 0.5),
                0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .list-item.low-risk {
            border-left-color: #10b981;
        }

        .list-item.low-risk:hover {
            box-shadow: 
                -4px 0 15px rgba(16, 185, 129, 0.5),
                0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .list-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.3vh;
            position: relative;
            z-index: 1;
            align-items: center;
        }

        .list-item-name {
            font-weight: 600;
            font-size: clamp(0.8rem, 1.2vw, 0.95rem);
            color: #e0f2fe;
        }

        .list-item-badge {
            padding: 0.2vh 0.6vw;
            border-radius: 10px;
            font-size: clamp(0.65rem, 1vw, 0.75rem);
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            animation: badgePulse 2s ease-in-out infinite;
            white-space: nowrap;
        }

        @keyframes badgePulse {
            0%, 100% {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            }
            50% {
                box-shadow: 0 2px 12px rgba(0, 0, 0, 0.5), 0 0 15px currentColor;
            }
        }

        .badge-high {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        }

        .badge-medium {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
        }

        .badge-low {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
        }

        .list-item-info {
            font-size: clamp(0.7rem, 1vw, 0.8rem);
            opacity: 0.9;
            margin-top: 0.3vh;
            position: relative;
            z-index: 1;
            color: #bfdbfe;
            line-height: 1.4;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 20vh;
            font-size: clamp(1rem, 1.5vw, 1.2rem);
            position: relative;
        }

        .loading::before {
            content: '';
            width: 50px;
            height: 50px;
            border: 3px solid rgba(59, 130, 246, 0.2);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        .loading::after {
            content: 'åŠ è½½ä¸­...';
            animation: loadingPulse 1.5s ease-in-out infinite;
            color: #60a5fa;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes loadingPulse {
            0%, 100% { 
                opacity: 0.5; 
                text-shadow: 0 0 5px rgba(59, 130, 246, 0.3);
            }
            50% { 
                opacity: 1; 
                text-shadow: 0 0 15px rgba(59, 130, 246, 0.8);
            }
        }

        /* ç©ºæ•°æ®æç¤º */
        .empty-data {
            text-align: center;
            padding: 4vh 2vw;
            opacity: 0.6;
            font-size: clamp(0.85rem, 1.3vw, 0.95rem);
            color: #93c5fd;
            animation: fadeInOut 2s ease-in-out infinite;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.8; }
        }

        /* å“åº”å¼ */
        @media (min-width: 1920px) {
            .dashboard-container {
                padding: 1.2vh 1.5vw;
            }
            
            .chart-container {
                min-height: 280px;
            }

            .chart-container-large {
                min-height: 380px;
            }
        }

        @media (max-width: 1600px) {
            .dashboard-body {
                grid-template-columns: 1fr 1.5fr 1fr;
            }
            
            .dashboard-header h1 {
                font-size: 1.8rem;
            }
        }

        @media (max-width: 1200px) {
            .dashboard-body {
                grid-template-columns: 1fr;
                overflow-y: auto;
                gap: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .card {
                padding: 15px;
            }

            .chart-container {
                height: 250px;
                max-height: none;
            }

            .chart-container-large {
                height: 300px;
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .dashboard-header h1 {
                font-size: 1.5rem;
            }
            
            .dashboard-header .subtitle {
                font-size: 0.75rem;
            }
            
            .dashboard-header .update-time {
                position: static;
                transform: none;
                margin-top: 5px;
                font-size: 0.7rem;
            }
        }

        /* å¹³æ¿æ¨ªå±é€‚é… (768px - 1024px) */
        @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
            .dashboard-container {
                padding: 1.2vh 1.5vw;
            }
            
            .dashboard-header {
                padding: 1.2vh 2vw;
                margin-bottom: 1.2vh;
            }
            
            .dashboard-header h1 {
                font-size: 1.6rem;
            }
            
            .dashboard-header .subtitle {
                font-size: 0.9rem;
            }
            
            .dashboard-header .update-time {
                font-size: 0.8rem;
            }
            
            .dashboard-body {
                grid-template-columns: 1fr 2fr 1fr;
                gap: 1.2vw;
            }
            
            .left-column,
            .middle-column,
            .right-column {
                gap: 1.2vh;
            }
            
            .card {
                padding: 1.2vh 1vw;
            }
            
            .card-title {
                font-size: 1.15rem;
                margin-bottom: 1vh;
            }
            
            .card-title .icon {
                font-size: 1.3rem;
            }
            
            .stats-grid {
                gap: 1vw;
            }
            
            .stat-item {
                padding: 1vh 0.8vw;
            }
            
            .stat-value {
                font-size: 2.2rem;
            }
            
            .stat-label {
                font-size: 0.85rem;
            }
            
            .chart-container {
                min-height: 200px;
                max-height: 220px;
            }
            
            .chart-container-large {
                min-height: 280px;
                max-height: 320px;
            }
            
            .list-item {
                padding: 0.9vh 0.8vw;
                margin-bottom: 0.9vh;
            }
            
            .list-item-name {
                font-size: 0.9rem;
            }
            
            .list-item-badge {
                font-size: 0.75rem;
                padding: 3px 8px;
            }
            
            .list-item-info {
                font-size: 0.8rem;
                line-height: 1.5;
            }
        }

        /* æ‰‹æœºç«¯ä¼˜åŒ– (æœ€å¤§ 480px) */
        @media (max-width: 480px) {
            .dashboard-container {
                padding: 0.5vh 2vw;
            }
            
            .dashboard-header {
                padding: 1vh 3vw;
                margin-bottom: 1vh;
            }
            
            .dashboard-header h1 {
                font-size: 1.2rem;
                margin-bottom: 0.5vh;
            }
            
            .dashboard-header .subtitle {
                font-size: 0.65rem;
                line-height: 1.3;
            }
            
            .dashboard-header .update-time {
                font-size: 0.65rem;
            }
            
            .dashboard-body {
                gap: 10px;
                overflow-y: visible;
            }
            
            .card {
                padding: 10px;
                margin-bottom: 10px;
            }
            
            .card-title {
                font-size: 0.95rem;
                margin-bottom: 8px;
                padding-bottom: 5px;
            }
            
            .card-title .icon {
                font-size: 1rem;
            }
            
            .stats-grid {
                gap: 8px;
            }
            
            .stat-item {
                padding: 8px;
            }
            
            .stat-value {
                font-size: 1.5rem;
                margin-bottom: 3px;
            }
            
            .stat-label {
                font-size: 0.7rem;
            }
            
            .chart-container {
                min-height: 200px;
                height: 200px;
            }
            
            .chart-container-large {
                min-height: 250px;
                height: 250px;
            }
            
            .list-item {
                padding: 8px;
                margin-bottom: 8px;
            }
            
            .list-item-name {
                font-size: 0.85rem;
            }
            
            .list-item-badge {
                font-size: 0.65rem;
                padding: 2px 6px;
            }
            
            .list-item-info {
                font-size: 0.7rem;
                line-height: 1.5;
            }
            
            /* ç§»åŠ¨ç«¯ï¼šç¦ç”¨æ‚¬åœæ•ˆæœï¼Œæ”¹ä¸ºè§¦æ‘¸ä¼˜åŒ– */
            .card:hover,
            .stat-item:hover,
            .list-item:hover {
                transform: none;
            }
            
            /* ç§»åŠ¨ç«¯ï¼šç®€åŒ–åŠ¨ç”»ä»¥æå‡æ€§èƒ½ */
            .card::before,
            .list-item::before,
            .stat-item::before {
                display: none;
            }
            
            /* ç§»åŠ¨ç«¯ï¼šä¼˜åŒ–ç²’å­æ•ˆæœ */
            .particle {
                display: none;
            }
        }

        /* æ¨ªå±æ‰‹æœºé€‚é…ï¼ˆå°å±æ¨ªå±ï¼‰ */
        @media (max-height: 500px) and (orientation: landscape) {
            .dashboard-container {
                padding: 0.5vh 1vw;
            }
            
            /* å¤´éƒ¨æåº¦å‹ç¼© */
            .dashboard-header {
                padding: 0.5vh 1.5vw;
                margin-bottom: 0.5vh;
            }
            
            .dashboard-header h1 {
                font-size: 0.95rem;
                margin-bottom: 0.2vh;
            }
            
            .dashboard-header .subtitle {
                font-size: 0.55rem;
                line-height: 1.2;
            }
            
            .dashboard-header .update-time {
                position: static;
                transform: none;
                margin-top: 2px;
                font-size: 0.5rem;
            }
            
            /* 3åˆ—è¶…ç´§å‡‘å¸ƒå±€ */
            .dashboard-body {
                grid-template-columns: 0.75fr 1.5fr 0.75fr;
                gap: 0.6vw;
            }
            
            .left-column,
            .middle-column,
            .right-column {
                gap: 0.4vh;
            }
            
            .card {
                padding: 0.5vh 0.6vw;
                border-radius: 10px;
            }
            
            .card-title {
                font-size: 0.75rem;
                margin-bottom: 0.3vh;
                padding-bottom: 0.2vh;
            }
            
            .card-title .icon {
                font-size: 0.8rem;
            }
            
            .stats-grid {
                gap: 0.4vw;
            }
            
            .stat-item {
                padding: 0.3vh 0.4vw;
            }
            
            .stat-value {
                font-size: 1.1rem;
                margin-bottom: 0.1vh;
            }
            
            .stat-label {
                font-size: 0.55rem;
            }
            
            /* å›¾è¡¨æåº¦å‹ç¼© */
            .chart-container {
                min-height: 100px;
                max-height: 100px;
            }
            
            .chart-container-large {
                min-height: 130px;
                max-height: 130px;
            }
            
            .data-list {
                min-height: 80px;
            }
            
            .list-item {
                padding: 0.3vh 0.5vw;
                margin-bottom: 0.3vh;
            }
            
            .list-item-name {
                font-size: 0.65rem;
            }
            
            .list-item-badge {
                font-size: 0.5rem;
                padding: 1px 4px;
            }
            
            .list-item-info {
                font-size: 0.55rem;
                margin-top: 0.1vh;
                line-height: 1.3;
            }
            
            /* ç¦ç”¨å¤æ‚åŠ¨ç”» */
            .card::before,
            .list-item::before,
            .stat-item::before,
            .particle {
                display: none;
            }
            
            /* ç®€åŒ–èƒŒæ™¯ */
            body::before {
                animation: none;
                opacity: 0.3;
            }
        }
        
        /* ä¸­ç­‰æ¨ªå±ï¼ˆå¦‚æ‰‹æœºæ¨ªå± 500px-700px é«˜åº¦ï¼‰ */
        @media (min-height: 500px) and (max-height: 700px) and (orientation: landscape) {
            .dashboard-container {
                padding: 0.7vh 1.2vw;
            }
            
            .dashboard-header {
                padding: 0.7vh 1.8vw;
                margin-bottom: 0.7vh;
            }
            
            .dashboard-header h1 {
                font-size: 1.1rem;
                margin-bottom: 0.3vh;
            }
            
            .dashboard-header .subtitle {
                font-size: 0.65rem;
            }
            
            .dashboard-header .update-time {
                font-size: 0.55rem;
            }
            
            .dashboard-body {
                grid-template-columns: 0.85fr 1.5fr 0.85fr;
                gap: 0.8vw;
            }
            
            .left-column,
            .middle-column,
            .right-column {
                gap: 0.6vh;
            }
            
            .card {
                padding: 0.6vh 0.7vw;
            }
            
            .card-title {
                font-size: 0.8rem;
                margin-bottom: 0.4vh;
                padding-bottom: 0.3vh;
            }
            
            .card-title .icon {
                font-size: 0.85rem;
            }
            
            .stats-grid {
                gap: 0.5vw;
            }
            
            .stat-item {
                padding: 0.4vh 0.5vw;
            }
            
            .stat-value {
                font-size: 1.4rem;
                margin-bottom: 0.2vh;
            }
            
            .stat-label {
                font-size: 0.6rem;
            }
            
            .chart-container {
                min-height: 120px;
                max-height: 140px;
            }
            
            .chart-container-large {
                min-height: 160px;
                max-height: 180px;
            }
            
            .data-list {
                min-height: 100px;
            }
            
            .list-item {
                padding: 0.4vh 0.6vw;
                margin-bottom: 0.4vh;
            }
            
            .list-item-name {
                font-size: 0.7rem;
            }
            
            .list-item-badge {
                font-size: 0.55rem;
                padding: 2px 5px;
            }
            
            .list-item-info {
                font-size: 0.6rem;
                margin-top: 0.2vh;
            }
            
            /* ç®€åŒ–åŠ¨ç”» */
            .card::before,
            .list-item::before,
            .stat-item::before {
                display: none;
            }
        }
        
        /* å¹³æ¿æ¨ªå±ï¼ˆé«˜åº¦ > 700pxï¼‰ */
        @media (min-height: 700px) and (max-width: 1200px) and (orientation: landscape) {
            .dashboard-body {
                grid-template-columns: 1fr 1.6fr 1fr;
                gap: 1vw;
            }
            
            .card {
                padding: 0.8vh 0.9vw;
            }
            
            .chart-container {
                min-height: 180px;
                max-height: 200px;
            }
            
            .chart-container-large {
                min-height: 240px;
                max-height: 280px;
            }
        }

        /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
        @media (hover: none) and (pointer: coarse) {
            /* å¢å¤§å¯ç‚¹å‡»åŒºåŸŸ */
            .stat-item,
            .list-item,
            .card {
                cursor: default;
                -webkit-tap-highlight-color: rgba(59, 130, 246, 0.2);
            }
            
            /* ç¦ç”¨æ‚¬åœåŠ¨ç”» */
            .card:hover::before,
            .list-item:hover::before {
                left: -100%;
            }
            
            /* ä¼˜åŒ–æ»šåŠ¨æ€§èƒ½ */
            .data-list {
                -webkit-overflow-scrolling: touch;
            }
        }

        /* å°å±è®¾å¤‡æ€§èƒ½ä¼˜åŒ– */
        @media (max-width: 768px) {
            /* å‡å°‘åŠ¨ç”»å¤æ‚åº¦ */
            * {
                animation-duration: 0.3s !important;
            }
            
            /* ç®€åŒ–èƒŒæ™¯æ•ˆæœ */
            body::before {
                animation: none;
                opacity: 0.5;
            }
        }

        /* æ•°æ®åŠ¨ç”» */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            animation: fadeIn 0.6s ease-out backwards;
        }

        .left-column .card:nth-child(1) { animation-delay: 0.1s; }
        .left-column .card:nth-child(2) { animation-delay: 0.2s; }
        .left-column .card:nth-child(3) { animation-delay: 0.3s; }
        .middle-column .card:nth-child(1) { animation-delay: 0.2s; }
        .middle-column .card:nth-child(2) { animation-delay: 0.3s; }
        .right-column .card:nth-child(1) { animation-delay: 0.3s; }
        .right-column .card:nth-child(2) { animation-delay: 0.4s; }
        .right-column .card:nth-child(3) { animation-delay: 0.5s; }

        /* æç¤ºæ¡† */
        .tooltip {
            position: fixed;
            background: linear-gradient(135deg, rgba(30, 64, 175, 0.95), rgba(37, 99, 235, 0.95));
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            pointer-events: none;
            z-index: 1000;
            display: none;
            border: 1px solid rgba(96, 165, 250, 0.3);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
        }

        /* é”™è¯¯æç¤º */
        .error-message {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.1));
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #fca5a5;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 20px;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
            animation: fadeIn 0.5s ease-out;
        }

        /* æ•°æ®åˆ·æ–°åŠ¨ç”» */
        .data-refresh {
            animation: dataRefresh 0.5s ease-out;
        }

        @keyframes dataRefresh {
            0% {
                opacity: 0.5;
                transform: scale(0.98);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>
<body>
    <!-- ç²’å­èƒŒæ™¯ -->
    <div class="particles" id="particles"></div>

    <div class="dashboard-container">
        <!-- å¤´éƒ¨ -->
        <div class="dashboard-header">
            <h1>ğŸ¥ æ™ºæ…§é€ å£æŠ¤ç†ä¸´åºŠå†³ç­–æ”¯æŒç³»ç»Ÿ</h1>
            <div class="subtitle">Intelligent Stoma Care Clinical Decision Support System - Real-time Data Analytics</div>
            <div class="update-time" id="updateTime">æœ€åæ›´æ–°: --</div>
        </div>

        <!-- ä¸»ä½“ -->
        <div class="dashboard-body" id="dashboardBody">
            <!-- å·¦ä¾§æ  -->
            <div class="left-column">
                <!-- æ ¸å¿ƒç»Ÿè®¡ -->
                <div class="card">
                    <div class="card-title">
                        <span class="icon">ğŸ“Š</span>
                        <span>æ ¸å¿ƒæŒ‡æ ‡</span>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="totalPatients">0</div>
                            <div class="stat-label">æ€»æ‚£è€…æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="activePatients">0</div>
                            <div class="stat-label">æ´»è·ƒæ‚£è€…</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalAssessments">0</div>
                            <div class="stat-label">æ€»è¯„ä¼°æ¬¡æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="pendingReviews">0</div>
                            <div class="stat-label">å¾…å®¡æ ¸</div>
                        </div>
                    </div>
                </div>

                <!-- ä»Šæ—¥æ•°æ® -->
                <div class="card">
                    <div class="card-title">
                        <span class="icon">ğŸ“…</span>
                        <span>ä»Šæ—¥æ•°æ®</span>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="todayAssessments">0</div>
                            <div class="stat-label">ä»Šæ—¥è¯„ä¼°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="todayDiaries">0</div>
                            <div class="stat-label">ä»Šæ—¥æ—¥è®°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="weekAssessments">0</div>
                            <div class="stat-label">æœ¬å‘¨è¯„ä¼°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="avgScore">0</div>
                            <div class="stat-label">å¹³å‡DETåˆ†</div>
                        </div>
                    </div>
                </div>

                <!-- DETç­‰çº§åˆ†å¸ƒ -->
                <div class="card" style="flex: 1.2;">
                    <div class="card-title">
                        <span class="icon">âš ï¸</span>
                        <span>DETç­‰çº§åˆ†å¸ƒ</span>
                    </div>
                    <div class="chart-container" id="riskChart"></div>
                </div>
            </div>

            <!-- ä¸­é—´æ  -->
            <div class="middle-column">
                <!-- è¯„ä¼°è¶‹åŠ¿ -->
                <div class="card" style="flex: 1;">
                    <div class="card-title">
                        <span class="icon">ğŸ“ˆ</span>
                        <span>è¯„ä¼°è¶‹åŠ¿åˆ†æï¼ˆè¿‘7å¤©ï¼‰</span>
                    </div>
                    <div class="chart-container-large" id="trendChart"></div>
                </div>

                <!-- DETç»´åº¦åˆ†æ -->
                <div class="card" style="flex: 1;">
                    <div class="card-title">
                        <span class="icon">ğŸ“‹</span>
                        <span>DETç»´åº¦åˆ†æï¼ˆç­‰çº§åˆ†å¸ƒ + å‡åˆ†ï¼‰</span>
                    </div>
                    <div class="chart-container" id="stageChart"></div>
                </div>
            </div>

            <!-- å³ä¾§æ  -->
            <div class="right-column">
                <!-- é€ å£ç±»å‹åˆ†å¸ƒ -->
                <div class="card">
                    <div class="card-title">
                        <span class="icon">ğŸ”</span>
                        <span>é€ å£ç±»å‹</span>
                    </div>
                    <div class="chart-container" id="stomaTypeChart"></div>
                </div>

                <!-- é‡ç‚¹å…³æ³¨æ‚£è€… -->
                <div class="card" style="flex: 1;">
                    <div class="card-title">
                        <span class="icon">ğŸš¨</span>
                        <span>é‡ç‚¹å…³æ³¨æ‚£è€…</span>
                    </div>
                    <div class="data-list" id="highRiskList"></div>
                </div>

                <!-- å¾…å®¡æ ¸è¯„ä¼° -->
                <div class="card" style="flex: 1;">
                    <div class="card-title">
                        <span class="icon">â°</span>
                        <span>å¾…å®¡æ ¸è¯„ä¼°</span>
                    </div>
                    <div class="data-list" id="pendingList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç»Ÿä¸€ä¸»é¢˜è‰²è·å–
        function getThemeColors() {
            const s = getComputedStyle(document.documentElement);
            return {
                primary200: s.getPropertyValue('--primary-200').trim() || '#93c5fd',
                primary300: s.getPropertyValue('--primary-300').trim() || '#60a5fa',
                primary400: s.getPropertyValue('--primary-400').trim() || '#3b82f6',
                primary500: s.getPropertyValue('--primary-500').trim() || '#2563eb',
                cyan: s.getPropertyValue('--accent-cyan').trim() || '#22d3ee',
                success: s.getPropertyValue('--success').trim() || '#34d399',
                warning: s.getPropertyValue('--warning').trim() || '#f59e0b',
                danger: s.getPropertyValue('--danger').trim() || '#ef4444',
                textSoft: s.getPropertyValue('--text-soft').trim() || '#e0f2fe'
            };
        }
        const THEME = getThemeColors();
        // é…ç½® - ä¼˜å…ˆä½¿ç”¨å¤–éƒ¨é…ç½®ï¼Œç„¶åæ˜¯localStorageï¼Œæœ€åæ˜¯é»˜è®¤å€¼
        const CONFIG = {
            apiBaseUrl: (window.DASHBOARD_CONFIG && window.DASHBOARD_CONFIG.apiBaseUrl) || 
                        localStorage.getItem('apiBaseUrl') || 
                        'http://localhost:3000/api',
            refreshInterval: (window.DASHBOARD_CONFIG && window.DASHBOARD_CONFIG.refreshInterval) || 30000,
            token: localStorage.getItem('token') || '',
            // è‡ªåŠ¨ç™»å½•é…ç½®ï¼ˆå¦‚æœæ²¡æœ‰tokenï¼Œä½¿ç”¨æ­¤è´¦å·è‡ªåŠ¨ç™»å½•ï¼‰
            autoLogin: (window.DASHBOARD_CONFIG && window.DASHBOARD_CONFIG.autoLogin) || {
                username: 'N001',  // é»˜è®¤ç”¨æˆ·åï¼ˆå·¥å·æˆ–æ‰‹æœºå·ï¼‰ï¼Œå¯åœ¨é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹
                password: '123456',  // é»˜è®¤å¯†ç ï¼ˆæµ‹è¯•æ¨¡å¼ä¸‹ä»»æ„å¯†ç å‡å¯ï¼‰ï¼Œå¯åœ¨é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹
                userType: 'nurse'   // ç”¨æˆ·ç±»å‹ï¼šnurse æˆ– patient
            }
        };
        
        // é…ç½®éªŒè¯å’Œè­¦å‘Š
        (function validateConfig() {
            console.log('%c=== Dashboard é…ç½®ä¿¡æ¯ ===', 'color: #3b82f6; font-size: 14px; font-weight: bold;');
            console.log('APIåœ°å€:', CONFIG.apiBaseUrl);
            console.log('è‡ªåŠ¨ç™»å½•ç”¨æˆ·:', CONFIG.autoLogin.username);
            console.log('é…ç½®æ¥æº:', window.DASHBOARD_CONFIG ? 'å¤–éƒ¨é…ç½®æ–‡ä»¶' : 'å†…ç½®é»˜è®¤é…ç½®');
            
            // æ£€æŸ¥é…ç½®æ˜¯å¦åŒ¹é…ç¯å¢ƒ
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const isLocalAPI = CONFIG.apiBaseUrl.includes('localhost') || CONFIG.apiBaseUrl.includes('127.0.0.1');
            
            if (isLocalhost && !isLocalAPI) {
                console.warn('%câš ï¸ è­¦å‘Š: æ‚¨åœ¨æœ¬åœ°ç¯å¢ƒè¿è¡Œï¼Œä½† API åœ°å€æŒ‡å‘ç”Ÿäº§ç¯å¢ƒï¼', 'color: #f59e0b; font-size: 13px;');
                console.log('å»ºè®®: ä¿®æ”¹ index.html ä¸­çš„é…ç½®æ–‡ä»¶ä¸º config.dev.js');
            } else if (!isLocalhost && isLocalAPI) {
                console.warn('%câš ï¸ è­¦å‘Š: æ‚¨åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œï¼Œä½† API åœ°å€æŒ‡å‘æœ¬åœ°ç¯å¢ƒï¼', 'color: #f59e0b; font-size: 13px;');
                console.log('å»ºè®®: ä¿®æ”¹ index.html ä¸­çš„é…ç½®æ–‡ä»¶ä¸º config.prod.js');
            }
            
            if (!window.DASHBOARD_CONFIG) {
                console.warn('%câš ï¸ è­¦å‘Š: é…ç½®æ–‡ä»¶å¯èƒ½æœªåŠ è½½ï¼Œæ­£åœ¨ä½¿ç”¨å†…ç½®é»˜è®¤é…ç½®', 'color: #f59e0b; font-size: 13px;');
            }
            
            console.log('');
        })();

        // åˆ›å»ºç²’å­èƒŒæ™¯
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 30;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                // éšæœºå¤§å°
                const size = Math.random() * 4 + 2;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                
                // éšæœºä½ç½®
                particle.style.left = `${Math.random() * 100}%`;
                
                // éšæœºåŠ¨ç”»æ—¶é•¿
                const duration = Math.random() * 20 + 15;
                particle.style.animationDuration = `${duration}s`;
                
                // éšæœºå»¶è¿Ÿ
                const delay = Math.random() * 10;
                particle.style.animationDelay = `${delay}s`;
                
                particlesContainer.appendChild(particle);
            }
        }

        // æ•°å­—æ»šåŠ¨åŠ¨ç”»
        function animateNumber(element, target, duration = 1000) {
            const start = parseInt(element.textContent) || 0;
            
            // å¦‚æœç›®æ ‡å€¼ä¸å½“å‰å€¼ç›¸åŒï¼Œä¸æ‰§è¡ŒåŠ¨ç”»
            if (start === target) {
                return;
            }
            
            const increment = (target - start) / (duration / 16);
            let current = start;
            
            // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§å®šæ—¶å™¨
            if (element.animationTimer) {
                clearInterval(element.animationTimer);
            }
            
            element.animationTimer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= target) || (increment < 0 && current <= target)) {
                    element.textContent = target;
                    clearInterval(element.animationTimer);
                    element.animationTimer = null;
                } else {
                    element.textContent = Math.round(current);
                }
            }, 16);
        }

        // æ•°å­—æ»šåŠ¨åŠ¨ç”»ï¼ˆæ”¯æŒå°æ•°ï¼‰
        function animateNumberDecimal(element, target, duration = 1000, decimals = 1) {
            const start = parseFloat(element.textContent) || 0;
            
            // å¦‚æœç›®æ ‡å€¼ä¸å½“å‰å€¼ç›¸åŒï¼ˆå…è®¸å°è¯¯å·®ï¼‰ï¼Œä¸æ‰§è¡ŒåŠ¨ç”»
            if (Math.abs(start - target) < 0.01) {
                element.textContent = target.toFixed(decimals);
                return;
            }
            
            const increment = (target - start) / (duration / 16);
            let current = start;
            
            // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§å®šæ—¶å™¨
            if (element.animationTimer) {
                clearInterval(element.animationTimer);
            }
            
            element.animationTimer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= target) || (increment < 0 && current <= target)) {
                    element.textContent = target.toFixed(decimals);
                    clearInterval(element.animationTimer);
                    element.animationTimer = null;
                } else {
                    element.textContent = current.toFixed(decimals);
                }
            }, 16);
        }

        // APIè¯·æ±‚å°è£…ï¼ˆå¸¦è‡ªåŠ¨é‡è¯•ç™»å½•ï¼‰
        async function fetchAPI(endpoint, retryLogin = true) {
            try {
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                // å¦‚æœæœ‰ tokenï¼Œåˆ™æ·»åŠ  Authorization header
                if (CONFIG.token) {
                    headers['Authorization'] = `Bearer ${CONFIG.token}`;
                }

                const response = await fetch(`${CONFIG.apiBaseUrl}${endpoint}`, {
                    headers
                });

                // å¦‚æœæ˜¯ 401 é”™è¯¯ä¸”å…è®¸é‡è¯•ï¼Œå°è¯•é‡æ–°ç™»å½•
                if (response.status === 401 && retryLogin) {
                    console.log('Tokenå·²è¿‡æœŸï¼Œå°è¯•è‡ªåŠ¨é‡æ–°ç™»å½•...');
                    try {
                        await autoLogin();
                        // é‡æ–°å‘é€è¯·æ±‚ï¼ˆåªé‡è¯•ä¸€æ¬¡ï¼‰
                        return await fetchAPI(endpoint, false);
                    } catch (loginError) {
                        throw new Error(`è‡ªåŠ¨ç™»å½•å¤±è´¥: ${loginError.message}`);
                    }
                }

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('APIè¯·æ±‚å¤±è´¥:', error);
                throw error;
            }
        }

        // åˆå§‹åŒ–å›¾è¡¨
        const charts = {
            risk: null,
            trend: null,
            stage: null,
            stomaType: null
        };

        // æ ¹æ®å±å¹•å°ºå¯¸è·å–å­—ä½“å¤§å°
        function getResponsiveFontSize() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            const isTablet = width >= 768 && width <= 1024;
            const isLandscape = width > height;
            
            if (isTablet && isLandscape) {
                // å¹³æ¿æ¨ªå±ï¼šå¢å¤§å­—ä½“
                return {
                    tooltip: 14,
                    legend: 13,
                    axisLabel: 13,
                    axisName: 14
                };
            } else if (width <= 768) {
                // æ‰‹æœºï¼šå°å­—ä½“
                return {
                    tooltip: 11,
                    legend: 10,
                    axisLabel: 10,
                    axisName: 11
                };
            } else {
                // æ¡Œé¢ï¼šæ ‡å‡†å­—ä½“
                return {
                    tooltip: 13,
                    legend: 12,
                    axisLabel: 11,
                    axisName: 12
                };
            }
        }

        // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
        function initCharts() {
            charts.risk = echarts.init(document.getElementById('riskChart'));
            charts.trend = echarts.init(document.getElementById('trendChart'));
            charts.stage = echarts.init(document.getElementById('stageChart'));
            charts.stomaType = echarts.init(document.getElementById('stomaTypeChart'));

            // å“åº”å¼
            window.addEventListener('resize', () => {
                Object.values(charts).forEach(chart => chart && chart.resize());
            });
        }

        // æ›´æ–°æ ¸å¿ƒç»Ÿè®¡æ•°æ®
        function updateCoreStats(data) {
            const { patientStats, assessmentStats } = data;

            // ä½¿ç”¨åŠ¨ç”»æ›´æ–°æ•°å­—ï¼ˆåªæœ‰æ•°å€¼å˜åŒ–æ—¶æ‰ä¼šæœ‰åŠ¨ç”»æ•ˆæœï¼‰
            animateNumber(document.getElementById('totalPatients'), patientStats.total_patients || 0);
            animateNumber(document.getElementById('activePatients'), patientStats.active_patients || 0);
            animateNumber(document.getElementById('totalAssessments'), assessmentStats.total_assessments || 0);
            animateNumber(document.getElementById('pendingReviews'), assessmentStats.pending_review || 0);

            animateNumber(document.getElementById('todayAssessments'), assessmentStats.today_assessments || 0);
            animateNumber(document.getElementById('weekAssessments'), assessmentStats.week_assessments || 0);
            // æ˜¾ç¤ºå¹³å‡DETè¯„åˆ†ï¼ˆ0-15åˆ†ï¼‰
            animateNumberDecimal(document.getElementById('avgScore'), Number(assessmentStats.avg_score) || 0, 1000, 1);
        }

        // æ›´æ–°ä»Šæ—¥æ•°æ®
        async function updateTodayData() {
            try {
                const result = await fetchAPI('/dashboard/realtime');
                if (result.success && result.data) {
                    const { todayData } = result.data;
                    animateNumber(document.getElementById('todayDiaries'), todayData.today_diaries || 0);
                }
            } catch (error) {
                console.error('è·å–ä»Šæ—¥æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ›´æ–°DETç­‰çº§åˆ†å¸ƒå›¾è¡¨
        function updateRiskChart(riskDistribution) {
            if (!charts.risk) return;
            
            const fontSize = getResponsiveFontSize();
            const T = THEME;
            
            // DETç­‰çº§æ˜ å°„ï¼ˆç®€åŒ–æ ‡ç­¾ï¼‰
            const riskMap = {
                'excellent': { 
                    value: 0, 
                    name: 'ä¼˜ç§€', 
                    fullName: 'ä¼˜ç§€-æ— çš®ç‚',
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                        {offset: 0, color: THEME.success},
                        {offset: 1, color: '#059669'}
                    ])
                },
                'good': { 
                    value: 0, 
                    name: 'è‰¯å¥½', 
                    fullName: 'è‰¯å¥½-è½»åº¦çš®ç‚',
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                        {offset: 0, color: '#7dd3fc'},
                        {offset: 1, color: T.primary300}
                    ])
                },
                'moderate': { 
                    value: 0, 
                    name: 'éœ€æ³¨æ„', 
                    fullName: 'ä¸­åº¦-éœ€æ³¨æ„',
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                        {offset: 0, color: T.warning},
                        {offset: 1, color: '#d97706'}
                    ])
                },
                'poor': { 
                    value: 0, 
                    name: 'éœ€å¤„ç†', 
                    fullName: 'é‡åº¦-éœ€å¤„ç†',
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                        {offset: 0, color: '#fb923c'},
                        {offset: 1, color: '#ea580c'}
                    ])
                },
                'critical': { 
                    value: 0, 
                    name: 'ç´§æ€¥', 
                    fullName: 'æé‡åº¦-ç´§æ€¥',
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                        {offset: 0, color: T.danger},
                        {offset: 1, color: '#dc2626'}
                    ])
                },
                'invalid': {
                    value: 0,
                    name: 'æ— æ³•è¯„ä¼°',
                    fullName: 'æ— æ³•è¯„ä¼°',
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                        {offset: 0, color: '#6b7280'},
                        {offset: 1, color: '#4b5563'}
                    ])
                }
            };

            riskDistribution.forEach(item => {
                if (riskMap[item.risk_level]) {
                    riskMap[item.risk_level].value = item.count;
                }
            });

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        const level = Object.keys(riskMap).find(k => riskMap[k].name === params.name);
                        const fullName = level ? riskMap[level].fullName : params.name;
                        return `${fullName}<br/>æ•°é‡: ${params.value} (${params.percent}%)`;
                    },
                    backgroundColor: 'rgba(30, 64, 175, 0.95)',
                    borderColor: 'rgba(96, 165, 250, 0.5)',
                    textStyle: {
                        color: '#fff',
                        fontSize: fontSize.tooltip
                    }
                },
                legend: {
                    orient: 'vertical',
                    right: '5%',
                    top: 'center',
                    itemGap: 10,
                    itemWidth: 18,
                    itemHeight: 18,
                    textStyle: {
                        color: T.textSoft,
                        fontSize: fontSize.legend,
                        padding: [0, 0, 0, 5]
                    }
                },
                series: [{
                    type: 'pie',
                    radius: ['45%', '75%'],
                    center: ['40%', '50%'],
                    data: [
                        { value: riskMap['excellent'].value, name: riskMap['excellent'].name, itemStyle: { color: riskMap['excellent'].color } },
                        { value: riskMap['good'].value, name: riskMap['good'].name, itemStyle: { color: riskMap['good'].color } },
                        { value: riskMap['moderate'].value, name: riskMap['moderate'].name, itemStyle: { color: riskMap['moderate'].color } },
                        { value: riskMap['poor'].value, name: riskMap['poor'].name, itemStyle: { color: riskMap['poor'].color } },
                        { value: riskMap['critical'].value, name: riskMap['critical'].name, itemStyle: { color: riskMap['critical'].color } },
                        { value: riskMap['invalid'].value, name: riskMap['invalid'].name, itemStyle: { color: riskMap['invalid'].color } }
                    ].filter(item => item.value > 0),  // åªæ˜¾ç¤ºæœ‰æ•°æ®çš„é¡¹
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 20,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(59, 130, 246, 0.8)'
                        },
                        scale: true,
                        scaleSize: 10
                    },
                    label: {
                        show: false  // éšè—é¥¼å›¾ä¸Šçš„æ ‡ç­¾ï¼Œé¿å…é‡å 
                    },
                    labelLine: {
                        show: false  // éšè—æ ‡ç­¾çº¿
                    },
                    animationType: 'scale',
                    animationEasing: 'elasticOut',
                    animationDelay: function (idx) {
                        return idx * 200;
                    }
                }]
            };

            // ä½¿ç”¨ notMerge: false æ¥æ›´æ–°è€Œä¸æ˜¯å®Œå…¨æ›¿æ¢ï¼Œå‡å°‘é—ªçƒ
            charts.risk.setOption(option, { notMerge: false, lazyUpdate: true });
        }

        // æ›´æ–°è¯„ä¼°è¶‹åŠ¿å›¾è¡¨
        function updateTrendChart(assessmentTrend) {
            if (!charts.trend) return;
            
            const fontSize = getResponsiveFontSize();
            const T = THEME;
            
            const dates = assessmentTrend.map(item => {
                const date = new Date(item.date);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });
            const counts = assessmentTrend.map(item => item.count);
            // DETè¯„åˆ†èŒƒå›´0-15åˆ†
            const scores = assessmentTrend.map(item => (Number(item.avg_score) || 0).toFixed(1));

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        crossStyle: {
                            color: 'rgba(96, 165, 250, 0.5)'
                        },
                        lineStyle: {
                            color: 'rgba(96, 165, 250, 0.5)'
                        }
                    },
                    backgroundColor: 'rgba(30, 64, 175, 0.95)',
                    borderColor: 'rgba(96, 165, 250, 0.5)',
                    textStyle: {
                        color: '#fff'
                    }
                },
                legend: {
                    data: ['è¯„ä¼°æ¬¡æ•°', 'DETå¹³å‡åˆ†'],
                    textStyle: {
                        color: T.textSoft,
                        fontSize: fontSize.legend
                    },
                    top: 0
                },
                grid: {
                    left: '5%',
                    right: '5%',
                    bottom: '8%',
                    top: '12%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: dates,
                    axisLine: {
                        lineStyle: {
                            color: 'rgba(96, 165, 250, 0.5)',
                            width: 2
                        }
                    },
                    axisLabel: {
                        color: T.textSoft,
                        fontSize: fontSize.axisLabel
                    },
                    axisTick: {
                        lineStyle: {
                            color: 'rgba(96, 165, 250, 0.3)'
                        }
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'è¯„ä¼°æ¬¡æ•°',
                        position: 'left',
                        nameTextStyle: {
                            color: T.success,
                            fontSize: fontSize.axisName
                        },
                        axisLine: {
                            lineStyle: {
                                color: 'rgba(74, 222, 128, 0.5)',
                                width: 2
                            }
                        },
                        axisLabel: {
                            color: T.textSoft,
                            fontSize: fontSize.axisLabel
                        },
                        splitLine: {
                            lineStyle: {
                                color: 'rgba(96, 165, 250, 0.1)',
                                type: 'dashed'
                            }
                        }
                    },
                    {
                        type: 'value',
                        name: 'DETå¹³å‡åˆ†',
                        position: 'right',
                        max: 15,  // DETè¯„åˆ†èŒƒå›´0-15
                        nameTextStyle: {
                            color: T.primary300,
                            fontSize: fontSize.axisName
                        },
                        axisLine: {
                            lineStyle: {
                                color: 'rgba(96, 165, 250, 0.5)',
                                width: 2
                            }
                        },
                        axisLabel: {
                            color: T.textSoft,
                            fontSize: fontSize.axisLabel
                        },
                        splitLine: {
                            show: false
                        }
                    }
                ],
                series: [
                    {
                        name: 'è¯„ä¼°æ¬¡æ•°',
                        type: 'line',
                        smooth: true,
                        data: counts,
                        yAxisIndex: 0,
                        symbolSize: 8,
                        itemStyle: {
                            color: T.success,
                            shadowBlur: 10,
                            shadowColor: 'rgba(74, 222, 128, 0.8)'
                        },
                        lineStyle: {
                            width: 3,
                            shadowBlur: 10,
                            shadowColor: 'rgba(74, 222, 128, 0.5)'
                        },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                {offset: 0, color: 'rgba(74, 222, 128, 0.6)'},
                                {offset: 1, color: 'rgba(74, 222, 128, 0.05)'}
                            ]),
                            shadowBlur: 20,
                            shadowColor: 'rgba(74, 222, 128, 0.3)'
                        },
                        emphasis: {
                            focus: 'series',
                            itemStyle: {
                                shadowBlur: 20,
                                shadowColor: 'rgba(74, 222, 128, 1)'
                            }
                        },
                        animationDelay: function (idx) {
                            return idx * 50;
                        }
                    },
                    {
                        name: 'DETå¹³å‡åˆ†',
                        type: 'line',
                        smooth: true,
                        data: scores,
                        yAxisIndex: 1,
                        symbolSize: 8,
                        itemStyle: {
                            color: T.primary300,
                            shadowBlur: 10,
                            shadowColor: 'rgba(96, 165, 250, 0.8)'
                        },
                        lineStyle: {
                            width: 3,
                            shadowBlur: 10,
                            shadowColor: 'rgba(96, 165, 250, 0.5)'
                        },
                        emphasis: {
                            focus: 'series',
                            itemStyle: {
                                shadowBlur: 20,
                                shadowColor: 'rgba(96, 165, 250, 1)'
                            }
                        },
                        animationDelay: function (idx) {
                            return idx * 50 + 300;
                        }
                    }
                ],
                animationEasing: 'elasticOut',
                animationDuration: 1000
            };

            charts.trend.setOption(option, { notMerge: false, lazyUpdate: true });
        }

        // æ›´æ–°DETç»´åº¦åˆ†æå›¾è¡¨
        function updateStageChart(stageDistribution) {
            if (!charts.stage) return;
            
            const fontSize = getResponsiveFontSize();
            
            // DETç»´åº¦å·²ç»æ˜¯ä¸­æ–‡ï¼Œç›´æ¥ä½¿ç”¨
            const stages = stageDistribution.map(item => item.pressure_stage || 'æœªçŸ¥');
            const counts = stageDistribution.map(item => Number(item.count) || 0);

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow',
                        shadowStyle: {
                            color: 'rgba(59, 130, 246, 0.2)'
                        }
                    },
                    formatter: function(params) {
                        const param = params[0];
                        return `${param.name}<br/>å¹³å‡åˆ†: ${param.value}/5`;
                    },
                    backgroundColor: 'rgba(30, 64, 175, 0.95)',
                    borderColor: 'rgba(96, 165, 250, 0.5)',
                    textStyle: {
                        color: '#fff'
                    }
                },
                grid: {
                    left: '5%',
                    right: '5%',
                    bottom: '12%',
                    top: '8%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: stages,
                    axisLine: {
                        lineStyle: {
                            color: 'rgba(96, 165, 250, 0.5)',
                            width: 2
                        }
                    },
                    axisLabel: {
                        color: '#e0f2fe',
                        rotate: 0,
                        fontSize: fontSize.axisLabel,
                        interval: 0
                    },
                    axisTick: {
                        lineStyle: {
                            color: 'rgba(96, 165, 250, 0.3)'
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    max: 5,  // DETå„ç»´åº¦æœ€é«˜5åˆ†
                    axisLine: {
                        lineStyle: {
                            color: 'rgba(96, 165, 250, 0.5)',
                            width: 2
                        }
                    },
                    axisLabel: {
                        color: '#e0f2fe',
                        fontSize: 11,
                        formatter: '{value}åˆ†'
                    },
                    splitLine: {
                        lineStyle: {
                            color: 'rgba(96, 165, 250, 0.1)',
                            type: 'dashed'
                        }
                    }
                },
                series: [{
                    type: 'bar',
                    data: counts,
                    barWidth: '50%',
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            {offset: 0, color: '#60a5fa'},
                            {offset: 1, color: '#3b82f6'}
                        ]),
                        borderRadius: [8, 8, 0, 0],
                        shadowBlur: 10,
                        shadowColor: 'rgba(59, 130, 246, 0.5)'
                    },
                    emphasis: {
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                {offset: 0, color: '#93c5fd'},
                                {offset: 1, color: '#60a5fa'}
                            ]),
                            shadowBlur: 20,
                            shadowColor: 'rgba(59, 130, 246, 0.8)'
                        }
                    },
                    animationDelay: function (idx) {
                        return idx * 100;
                    }
                }],
                animationEasing: 'elasticOut',
                animationDuration: 800
            };

            charts.stage.setOption(option, { notMerge: false, lazyUpdate: true });
        }

        // æ–°å¢ï¼šDETç»´åº¦ä¸°å¯Œå±•ç¤ºï¼ˆå †å æŸ± + å¹³å‡åˆ†æŠ˜çº¿ï¼‰
        async function loadDETStageStats() {
            try {
                const result = await fetchAPI('/dashboard/stage-stats');
                if (result.success && result.data) {
                    updateStageChartRich(result.data);
                }
            } catch (e) {
                console.error('DETç»´åº¦ç»Ÿè®¡åŠ è½½å¤±è´¥', e);
                // å…¼å®¹ï¼šå¦‚æœç”Ÿäº§åç«¯æœªå‡çº§ï¼Œä½¿ç”¨æ—§æ¥å£çš„å¹³å‡åˆ†å›¾è¡¨ä½œä¸ºå…œåº•
                if (window.__STAGE_DISTRIBUTION__ && window.__STAGE_DISTRIBUTION__.length) {
                    console.warn('ä½¿ç”¨æ—§æ¥å£ stageDistribution åšå…œåº•å±•ç¤ºï¼ˆå¹³å‡åˆ†æŸ±çŠ¶ï¼‰');
                    updateStageChart(window.__STAGE_DISTRIBUTION__);
                }
            }
        }

        function updateStageChartRich(stageDetail) {
            if (!charts.stage) return;
            const fontSize = getResponsiveFontSize();
            const T = THEME;
            const stages = stageDetail.map(item => item.dimension);
            const excellent = stageDetail.map(item => item.excellent || 0);
            const moderate = stageDetail.map(item => item.moderate || 0);
            const critical = stageDetail.map(item => item.critical || 0);
            const avgScores = stageDetail.map(item => item.avg_score || 0);

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    backgroundColor: 'rgba(30, 64, 175, 0.95)',
                    borderColor: 'rgba(96, 165, 250, 0.5)',
                    textStyle: { color: '#fff', fontSize: fontSize.tooltip },
                    formatter: function(params) {
                        const idx = params[0].dataIndex;
                        const item = stageDetail[idx];
                        return `${item.dimension}<br/>
                                å¹³å‡åˆ†: <b>${item.avg_score}</b>/5<br/>
                                <span style="color:#10b981;">ä¼˜ç§€</span>: ${item.excellent}ï¼Œ
                                <span style="color:#f59e0b;">éœ€æ³¨æ„</span>: ${item.moderate}ï¼Œ
                                <span style="color:#ef4444;">ç´§æ€¥</span>: ${item.critical}<br/>
                                æœ€é«˜åˆ†: ${item.max_score}ï¼Œæœ€ä½åˆ†: ${item.min_score}`;
                    }
                },
                legend: {
                    data: ['ä¼˜ç§€', 'éœ€æ³¨æ„', 'ç´§æ€¥', 'å¹³å‡åˆ†'],
                    textStyle: { color: T.textSoft, fontSize: fontSize.legend },
                    itemWidth: 18,
                    itemHeight: 12
                },
                grid: {
                    left: '5%',
                    right: '5%',
                    bottom: '12%',
                    top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: stages,
                    axisLine: { lineStyle: { color: 'rgba(96, 165, 250, 0.5)', width: 2 } },
                    axisLabel: { color: T.textSoft, fontSize: fontSize.axisLabel }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'äººæ•°',
                        axisLine: { lineStyle: { color: 'rgba(96, 165, 250, 0.5)', width: 2 } },
                        axisLabel: { color: T.textSoft, fontSize: fontSize.axisLabel },
                        splitLine: { lineStyle: { color: 'rgba(96, 165, 250, 0.08)', type: 'dashed' } }
                    },
                    {
                        type: 'value',
                        name: 'å¹³å‡åˆ†',
                        min: 0,
                        max: 5,
                        axisLine: { lineStyle: { color: 'rgba(96, 165, 250, 0.5)', width: 2 } },
                        axisLabel: { color: T.textSoft, fontSize: fontSize.axisLabel },
                        splitLine: { show: false }
                    }
                ],
                series: [
                    {
                        name: 'ä¼˜ç§€',
                        type: 'bar',
                        stack: 'risk',
                        data: excellent,
                        barWidth: '42%',
                        showBackground: true,
                        backgroundStyle: { color: 'rgba(255,255,255,0.02)' },
                        itemStyle: { 
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: T.success },
                                { offset: 1, color: '#059669' }
                            ]),
                            borderRadius: [10, 10, 0, 0],
                            shadowBlur: 12,
                            shadowColor: 'rgba(16,185,129,0.35)'
                        },
                        emphasis: { focus: 'series' },
                        animationDelay: function (idx) { return idx * 60; }
                    },
                    {
                        name: 'éœ€æ³¨æ„',
                        type: 'bar',
                        stack: 'risk',
                        data: moderate,
                        itemStyle: { 
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: T.warning },
                                { offset: 1, color: '#d97706' }
                            ]),
                            borderRadius: [10, 10, 0, 0],
                            shadowBlur: 12,
                            shadowColor: 'rgba(245,158,11,0.35)'
                        },
                        emphasis: { focus: 'series' },
                        animationDelay: function (idx) { return idx * 60 + 120; }
                    },
                    {
                        name: 'ç´§æ€¥',
                        type: 'bar',
                        stack: 'risk',
                        data: critical,
                        itemStyle: { 
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#f87171' },
                                { offset: 1, color: T.danger }
                            ]),
                            borderRadius: [10, 10, 0, 0],
                            shadowBlur: 14,
                            shadowColor: 'rgba(239,68,68,0.4)'
                        },
                        emphasis: { focus: 'series' },
                        animationDelay: function (idx) { return idx * 60 + 240; }
                    },
                    {
                        name: 'å¹³å‡åˆ†',
                        type: 'line',
                        yAxisIndex: 1,
                        data: avgScores,
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 10,
                        itemStyle: { color: T.primary200, shadowBlur: 18, shadowColor: 'rgba(147,197,253,0.9)' },
                        lineStyle: { width: 3, color: T.primary300, shadowBlur: 12, shadowColor: 'rgba(96,165,250,0.6)' },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(96,165,250,0.25)' },
                                { offset: 1, color: 'rgba(96,165,250,0.02)' }
                            ])
                        },
                        markPoint: {
                            data: [
                                { type: 'max', name: 'æœ€é«˜', itemStyle: { color: '#10b981' } },
                                { type: 'min', name: 'æœ€ä½', itemStyle: { color: T.danger } }
                            ],
                            symbolSize: 48,
                            label: { color: '#0b1220', fontWeight: 700 }
                        },
                        z: 3,
                        animationDelay: function (idx) { return idx * 60 + 120; }
                    },
                    {
                        // æ¶Ÿæ¼ªç‚¹ï¼Œè®©å‡åˆ†æŠ˜çº¿æ›´æœ‰æ´»åŠ›
                        name: 'å¹³å‡åˆ†-æ¶Ÿæ¼ª',
                        type: 'effectScatter',
                        yAxisIndex: 1,
                        data: avgScores,
                        symbolSize: 12,
                        itemStyle: { color: T.primary300 },
                        rippleEffect: { brushType: 'stroke', color: '#93c5fd', scale: 2.5 },
                        z: 4
                    }
                ],
                animationEasing: 'elasticOut',
                animationDuration: 900
            };

            charts.stage.setOption(option, { notMerge: false, lazyUpdate: true });
        }

        // æ›´æ–°é€ å£ç±»å‹å›¾è¡¨
        function updateStomaTypeChart(stomaTypeDistribution) {
            if (!charts.stomaType) return;
            
            const fontSize = getResponsiveFontSize();
            const T = THEME;
            
            // é€ å£ç±»å‹ä¸­è‹±æ–‡æ˜ å°„
            const stomaTypeMap = {
                'colostomy': 'ç»“è‚ é€ å£',
                'ileostomy': 'å›è‚ é€ å£',
                'urostomy': 'æ³Œå°¿é€ å£',
                'gastrostomy': 'èƒƒé€ å£',
                'jejunostomy': 'ç©ºè‚ é€ å£',
                'tracheostomy': 'æ°”ç®¡é€ å£'
            };
            
            const types = stomaTypeDistribution.map(item => {
                const originalType = item.stoma_type || 'æœªçŸ¥';
                return stomaTypeMap[originalType] || originalType;
            });
            const counts = stomaTypeDistribution.map(item => item.count);

            // è“ç™½è‰²ç³»é…è‰²
            const colors = [
                new echarts.graphic.LinearGradient(0, 0, 1, 1, [
                    {offset: 0, color: T.primary300},
                    {offset: 1, color: T.primary400}
                ]),
                new echarts.graphic.LinearGradient(0, 0, 1, 1, [
                    {offset: 0, color: T.primary200},
                    {offset: 1, color: T.primary300}
                ]),
                new echarts.graphic.LinearGradient(0, 0, 1, 1, [
                    {offset: 0, color: '#e5efff'},
                    {offset: 1, color: T.primary200}
                ]),
                new echarts.graphic.LinearGradient(0, 0, 1, 1, [
                    {offset: 0, color: T.primary400},
                    {offset: 1, color: T.primary500}
                ])
            ];

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c} ({d}%)',
                    backgroundColor: 'rgba(30, 64, 175, 0.95)',
                    borderColor: 'rgba(96, 165, 250, 0.5)',
                    textStyle: {
                        color: '#fff'
                    }
                },
                legend: {
                    orient: 'vertical',
                    right: 10,
                    top: 'center',
                    textStyle: {
                        color: T.textSoft,
                        fontSize: fontSize.legend
                    }
                },
                series: [{
                    type: 'pie',
                    radius: ['35%', '65%'],
                    center: ['40%', '50%'],
                    data: types.map((type, index) => ({
                        value: counts[index],
                        name: type,
                        itemStyle: {
                            color: colors[index % colors.length],
                            shadowBlur: 10,
                            shadowColor: 'rgba(59, 130, 246, 0.5)'
                        }
                    })),
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 20,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(59, 130, 246, 0.8)'
                        },
                        scale: true,
                        scaleSize: 10
                    },
                    label: {
                        color: '#fff',
                        fontSize: fontSize.legend,
                        formatter: '{b}\n{d}%'
                    },
                    labelLine: {
                        lineStyle: {
                            color: 'rgba(255, 255, 255, 0.5)'
                        }
                    },
                    animationType: 'scale',
                    animationEasing: 'elasticOut',
                    animationDelay: function (idx) {
                        return idx * 150;
                    }
                }]
            };

            charts.stomaType.setOption(option, { notMerge: false, lazyUpdate: true });
        }

        // æ›´æ–°é‡ç‚¹å…³æ³¨æ‚£è€…åˆ—è¡¨
        function updateHighRiskList(highRiskPatients) {
            const listContainer = document.getElementById('highRiskList');
            
            if (!highRiskPatients || highRiskPatients.length === 0) {
                listContainer.innerHTML = '<div class="empty-data">æš‚æ— é‡ç‚¹å…³æ³¨æ‚£è€…</div>';
                listContainer.classList.remove('auto-scroll');
                return;
            }

            const html = highRiskPatients.map(patient => {
                // æ ¹æ®DETç­‰çº§ç¡®å®šæ ·å¼
                const detLevel = patient.risk_level;
                const riskClass = detLevel === 'critical' || detLevel === 'poor' ? 'high-risk' : 
                                detLevel === 'moderate' ? 'medium-risk' : 'low-risk';
                const badgeClass = detLevel === 'critical' || detLevel === 'poor' ? 'badge-high' : 
                                  detLevel === 'moderate' ? 'badge-medium' : 'badge-low';
                
                // DETç­‰çº§ä¸­æ–‡æ˜¾ç¤º
                const detLevelText = getDetLevelTextChinese(detLevel);
                
                const date = new Date(patient.assessment_date);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                // æ˜¾ç¤ºDETæ€»åˆ†
                const detTotal = patient.det_total || patient.score || 0;

                return `
                    <div class="list-item ${riskClass}">
                        <div class="list-item-header">
                            <span class="list-item-name">${patient.name}</span>
                            <span class="list-item-badge ${badgeClass}">${detLevelText}</span>
                        </div>
                        <div class="list-item-info">
                            DETè¯„åˆ†: ${detTotal}/15åˆ†<br>
                            ${patient.stoma_type || 'æœªçŸ¥ç±»å‹'} | ${dateStr}
                        </div>
                    </div>
                `;
            }).join('');

            // å¦‚æœæ•°æ®è¶…è¿‡3æ¡ï¼Œå¯ç”¨è‡ªåŠ¨æ»šåŠ¨
            if (highRiskPatients.length >= 3) {
                listContainer.classList.add('auto-scroll');
                // å¤åˆ¶å†…å®¹å®ç°æ— é™å¾ªç¯æ»šåŠ¨
                listContainer.innerHTML = `<div class="scroll-content">${html}${html}</div>`;
            } else {
                listContainer.classList.remove('auto-scroll');
                listContainer.innerHTML = html;
            }
        }

        // DETç­‰çº§æ˜ å°„ï¼ˆè‹±æ–‡è½¬ä¸­æ–‡ï¼‰
        function getDetLevelTextChinese(detLevel) {
            const levelMap = {
                'excellent': 'ä¼˜ç§€',
                'good': 'è‰¯å¥½',
                'moderate': 'éœ€æ³¨æ„',
                'poor': 'éœ€å¤„ç†',
                'critical': 'ç´§æ€¥'
            };
            return levelMap[detLevel] || detLevel || 'æœªçŸ¥';
        }
        
        // æ—§å‡½æ•°ä¿ç•™ç”¨äºå…¼å®¹
        function getStageTextChinese(stage) {
            return getDetLevelTextChinese(stage);
        }

        // æ›´æ–°å¾…å®¡æ ¸åˆ—è¡¨
        function updatePendingList(pendingReviews) {
            const listContainer = document.getElementById('pendingList');
            
            if (!pendingReviews || pendingReviews.length === 0) {
                listContainer.innerHTML = '<div class="empty-data">æš‚æ— å¾…å®¡æ ¸è¯„ä¼°</div>';
                listContainer.classList.remove('auto-scroll');
                return;
            }

            const html = pendingReviews.map(review => {
                // æ ¹æ®DETç­‰çº§ç¡®å®šæ ·å¼
                const detLevel = review.risk_level;
                const riskClass = detLevel === 'critical' || detLevel === 'poor' ? 'high-risk' : 
                                detLevel === 'moderate' ? 'medium-risk' : 'low-risk';
                const badgeClass = detLevel === 'critical' || detLevel === 'poor' ? 'badge-high' : 
                                  detLevel === 'moderate' ? 'badge-medium' : 'badge-low';
                
                const date = new Date(review.assessment_date);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                // DETç­‰çº§ä¸­æ–‡æ˜¾ç¤º
                const detLevelText = getDetLevelTextChinese(detLevel);
                
                // æ˜¾ç¤ºDETæ€»åˆ†
                const detTotal = review.det_total || review.score || 0;

                return `
                    <div class="list-item ${riskClass}">
                        <div class="list-item-header">
                            <span class="list-item-name">${review.patient_name}</span>
                            <span class="list-item-badge ${badgeClass}">${detLevelText}</span>
                        </div>
                        <div class="list-item-info">
                            DETè¯„åˆ†: ${detTotal}/15åˆ† | ${dateStr}
                        </div>
                    </div>
                `;
            }).join('');

            // å¦‚æœæ•°æ®è¶…è¿‡3æ¡ï¼Œå¯ç”¨è‡ªåŠ¨æ»šåŠ¨
            if (pendingReviews.length >= 3) {
                listContainer.classList.add('auto-scroll');
                // å¤åˆ¶å†…å®¹å®ç°æ— é™å¾ªç¯æ»šåŠ¨
                listContainer.innerHTML = `<div class="scroll-content">${html}${html}</div>`;
            } else {
                listContainer.classList.remove('auto-scroll');
                listContainer.innerHTML = html;
            }
        }

        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTimeDisplay() {
            const now = new Date();
            const timeStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
            document.getElementById('updateTime').textContent = `æœ€åæ›´æ–°: ${timeStr}`;
        }

        // åŠ è½½æ‰€æœ‰æ•°æ®
        async function loadDashboardData() {
            try {
                const result = await fetchAPI('/dashboard/stats');
                
                if (result.success && result.data) {
                    const data = result.data;

                    // æ›´æ–°å„ä¸ªéƒ¨åˆ†
                    updateCoreStats(data);
                    updateRiskChart(data.riskDistribution || []);
                    updateTrendChart(data.assessmentTrend || []);
                    updateStomaTypeChart(data.stomaTypeDistribution || []);
                    updateHighRiskList(data.highRiskPatients || []);
                    updatePendingList(data.pendingReviews || []);
                    // å­˜å‚¨æ—§æ¥å£çš„ç»´åº¦å¹³å‡åˆ†ï¼Œä¾¿äºåœ¨ç”Ÿäº§ç¯å¢ƒåç«¯æœªå‡çº§æ—¶å…œåº•å±•ç¤º
                    window.__STAGE_DISTRIBUTION__ = data.stageDistribution || [];

                    // æ›´æ–°ä»Šæ—¥æ•°æ®
                    await updateTodayData();

                    // æ›´æ–°æ—¶é—´
                    updateTimeDisplay();
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                showError('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œåç«¯æœåŠ¡');
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const dashboardBody = document.getElementById('dashboardBody');
            const apiUrl = CONFIG.apiBaseUrl;
            const autoLoginConfig = CONFIG.autoLogin;
            
            // æ ¼å¼åŒ–æ¶ˆæ¯ï¼ˆä¿ç•™æ¢è¡Œï¼‰
            const formattedMessage = message.replace(/\n/g, '<br>');
            
            dashboardBody.innerHTML = `
                <div class="error-message">
                    âŒ ${formattedMessage}
                    <br><br>
                    <div style="font-size: 0.9em; opacity: 0.8; margin-top: 20px; text-align: left; max-width: 700px; margin-left: auto; margin-right: auto;">
                        <strong>è¯Šæ–­ä¿¡æ¯ï¼š</strong><br>
                        â€¢ APIåœ°å€: ${apiUrl}<br>
                        â€¢ æµè§ˆå™¨: ${navigator.userAgent.split(' ').pop()}<br>
                        â€¢ è‡ªåŠ¨ç™»å½•ç”¨æˆ·å: ${autoLoginConfig.username || 'æœªé…ç½®'}<br>
                        â€¢ ç”¨æˆ·ç±»å‹: ${autoLoginConfig.userType || 'nurse'}<br><br>
                        <strong>å¿«é€Ÿè¯Šæ–­æ­¥éª¤ï¼š</strong><br>
                        <div style="background: rgba(59, 130, 246, 0.15); padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 3px solid #3b82f6;">
                            <div style="margin-bottom: 8px;">1ï¸âƒ£ æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨</div>
                            <div style="margin-left: 20px; font-size: 0.9em; color: #93c5fd;">
                                â€¢ æ‰“å¼€å‘½ä»¤è¡Œ/ç»ˆç«¯<br>
                                â€¢ è¿›å…¥é¡¹ç›®çš„ backend ç›®å½•<br>
                                â€¢ è¿è¡Œå‘½ä»¤: <code style="background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 4px;">npm start</code><br>
                                â€¢ çœ‹åˆ° "ğŸš€ é€ å£æŠ¤ç†ç³»ç»Ÿåç«¯æœåŠ¡å·²å¯åŠ¨" å³ä¸ºæˆåŠŸ
                            </div>
                        </div>
                        <div style="background: rgba(59, 130, 246, 0.15); padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 3px solid #10b981;">
                            <div style="margin-bottom: 8px;">2ï¸âƒ£ æ£€æŸ¥ API åœ°å€é…ç½®</div>
                            <div style="margin-left: 20px; font-size: 0.9em; color: #93c5fd;">
                                â€¢ å½“å‰ API åœ°å€: <strong>${apiUrl}</strong><br>
                                â€¢ æœ¬åœ°å¼€å‘åº”ä¸º: http://localhost:3000/api<br>
                                â€¢ æ£€æŸ¥ config.dev.js æˆ– config.prod.js æ–‡ä»¶
                            </div>
                        </div>
                        <div style="background: rgba(59, 130, 246, 0.15); padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 3px solid #f59e0b;">
                            <div style="margin-bottom: 8px;">3ï¸âƒ£ æ£€æŸ¥è‡ªåŠ¨ç™»å½•é…ç½®</div>
                            <div style="margin-left: 20px; font-size: 0.9em; color: #93c5fd;">
                                â€¢ ç”¨æˆ·ååº”ä¸ºå·¥å·ï¼ˆå¦‚ N001ï¼‰æˆ–æ‰‹æœºå·ï¼ˆå¦‚ 13800138000ï¼‰<br>
                                â€¢ å½“å‰ç”¨æˆ·å: <strong>${autoLoginConfig.username}</strong><br>
                                â€¢ å¦‚æœæ˜¯ 'admin'ï¼Œè¯·æ”¹ä¸º 'N001'
                            </div>
                        </div>
                        <br>
                        <strong>å…¶ä»–å¯èƒ½çš„åŸå› ï¼š</strong><br>
                        â€¢ æ•°æ®åº“æœªåˆå§‹åŒ–æˆ–æ— æ•°æ®<br>
                        â€¢ è·¨åŸŸé—®é¢˜ï¼ˆæ£€æŸ¥åç«¯CORSé…ç½®ï¼‰<br>
                        â€¢ ç½‘ç»œè¿æ¥é—®é¢˜<br>
                    </div>
                    <div style="margin-top: 30px;">
                        <button onclick="testConnection()" style="padding: 12px 24px; margin: 0 10px; background: #3b82f6; border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 14px; font-weight: 600; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);">ğŸ” æµ‹è¯•è¿æ¥</button>
                        <button onclick="location.reload()" style="padding: 12px 24px; margin: 0 10px; background: #10b981; border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 14px; font-weight: 600; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);">ğŸ”„ åˆ·æ–°é¡µé¢</button>
                    </div>
                </div>
            `;
        }
        
        // æµ‹è¯•APIè¿æ¥
        async function testConnection() {
            const resultDiv = document.querySelector('.error-message');
            resultDiv.innerHTML += '<div style="margin-top: 20px; padding: 15px; background: rgba(59, 130, 246, 0.2); border-radius: 8px; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;"><strong>æ­£åœ¨æµ‹è¯•è¿æ¥...</strong><br><br></div>';
            
            const testDiv = resultDiv.querySelector('div:last-child');
            
            // æµ‹è¯•1: å¥åº·æ£€æŸ¥ï¼ˆä¸éœ€è¦è®¤è¯ï¼‰
            testDiv.innerHTML += '<div style="margin: 10px 0;">æµ‹è¯• 1. å¥åº·æ£€æŸ¥...</div>';
            try {
                const healthResponse = await fetch(`${CONFIG.apiBaseUrl}/health`, {
                    headers: { 'Content-Type': 'application/json' }
                });
                const healthData = await healthResponse.json();
                
                if (healthResponse.ok) {
                    testDiv.innerHTML += `<div style="color: #4ade80;">âœ“ 1. å¥åº·æ£€æŸ¥: æˆåŠŸ (${healthResponse.status})</div>`;
                    testDiv.innerHTML += `<div style="color: #93c5fd; font-size: 0.85em; margin-left: 20px;">æœåŠ¡å™¨å“åº”: ${healthData.message || 'æœåŠ¡è¿è¡Œæ­£å¸¸'}</div>`;
                } else {
                    testDiv.innerHTML += `<div style="color: #f87171;">âœ— 1. å¥åº·æ£€æŸ¥: å¤±è´¥ (${healthResponse.status})</div>`;
                    testDiv.innerHTML += `<div style="color: #fca5a5; font-size: 0.85em; margin-left: 20px;">é”™è¯¯: ${healthData.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
                }
            } catch (error) {
                testDiv.innerHTML += `<div style="color: #f87171;">âœ— 1. å¥åº·æ£€æŸ¥: ç½‘ç»œé”™è¯¯</div>`;
                testDiv.innerHTML += `<div style="color: #fca5a5; font-size: 0.85em; margin-left: 20px;">é”™è¯¯: ${error.message}</div>`;
            }
            
            // æµ‹è¯•2: å°è¯•è‡ªåŠ¨ç™»å½•
            testDiv.innerHTML += '<div style="margin: 10px 0;">æµ‹è¯• 2. è‡ªåŠ¨ç™»å½•...</div>';
            let testToken = CONFIG.token;
            try {
                // å¦‚æœtokenä¸å­˜åœ¨æˆ–æ— æ•ˆï¼Œå°è¯•è‡ªåŠ¨ç™»å½•
                if (!testToken) {
                    testDiv.innerHTML += '<div style="color: #93c5fd; font-size: 0.85em; margin-left: 20px;">æœªæ‰¾åˆ°æœ‰æ•ˆtokenï¼Œå°è¯•è‡ªåŠ¨ç™»å½•...</div>';
                    await autoLogin();
                    testToken = CONFIG.token;
                }
                
                if (testToken) {
                    testDiv.innerHTML += `<div style="color: #4ade80;">âœ“ 2. è‡ªåŠ¨ç™»å½•: æˆåŠŸ</div>`;
                    testDiv.innerHTML += `<div style="color: #93c5fd; font-size: 0.85em; margin-left: 20px;">Tokenå·²è·å–ï¼ˆ${testToken.substring(0, 20)}...ï¼‰</div>`;
                } else {
                    testDiv.innerHTML += `<div style="color: #f87171;">âœ— 2. è‡ªåŠ¨ç™»å½•: å¤±è´¥</div>`;
                    testDiv.innerHTML += `<div style="color: #fca5a5; font-size: 0.85em; margin-left: 20px;">é”™è¯¯: æ— æ³•è·å–tokenï¼Œè¯·æ£€æŸ¥è‡ªåŠ¨ç™»å½•é…ç½®</div>`;
                }
            } catch (error) {
                testDiv.innerHTML += `<div style="color: #f87171;">âœ— 2. è‡ªåŠ¨ç™»å½•: å¤±è´¥</div>`;
                testDiv.innerHTML += `<div style="color: #fca5a5; font-size: 0.85em; margin-left: 20px;">é”™è¯¯: ${error.message}</div>`;
                testDiv.innerHTML += `<div style="color: #fca5a5; font-size: 0.85em; margin-left: 20px;">æç¤º: è¯·æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„ç”¨æˆ·åå’Œå¯†ç ï¼ˆç”¨æˆ·ååº”ä¸ºå·¥å·å¦‚ N001 æˆ–æ‰‹æœºå·å¦‚ 13800138000ï¼‰</div>`;
            }
            
            // æµ‹è¯•3: Dashboard APIï¼ˆéœ€è¦è®¤è¯ï¼‰
            testDiv.innerHTML += '<div style="margin: 10px 0;">æµ‹è¯• 3. Dashboard API...</div>';
            if (testToken) {
                try {
                    const dashboardResponse = await fetch(`${CONFIG.apiBaseUrl}/dashboard/stats`, {
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${testToken}`
                        }
                    });
                    const dashboardData = await dashboardResponse.json();
                    
                    if (dashboardResponse.ok) {
                        testDiv.innerHTML += `<div style="color: #4ade80;">âœ“ 3. Dashboard API: æˆåŠŸ (${dashboardResponse.status})</div>`;
                        testDiv.innerHTML += `<div style="color: #93c5fd; font-size: 0.85em; margin-left: 20px;">æ•°æ®å·²æˆåŠŸåŠ è½½</div>`;
                        // å¦‚æœæ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡ï¼Œå»ºè®®åˆ·æ–°é¡µé¢
                        testDiv.innerHTML += '<br><div style="color: #4ade80; font-weight: bold;">æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼å»ºè®®åˆ·æ–°é¡µé¢ä»¥åŠ è½½æ•°æ®ã€‚</div>';
                    } else {
                        testDiv.innerHTML += `<div style="color: #f87171;">âœ— 3. Dashboard API: å¤±è´¥ (${dashboardResponse.status})</div>`;
                        testDiv.innerHTML += `<div style="color: #fca5a5; font-size: 0.85em; margin-left: 20px;">é”™è¯¯: ${dashboardData.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
                        if (dashboardResponse.status === 401) {
                            testDiv.innerHTML += `<div style="color: #fca5a5; font-size: 0.85em; margin-left: 20px;">æç¤º: Tokenå¯èƒ½å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°é¡µé¢é‡æ–°ç™»å½•</div>`;
                        }
                    }
                } catch (error) {
                    testDiv.innerHTML += `<div style="color: #f87171;">âœ— 3. Dashboard API: ç½‘ç»œé”™è¯¯</div>`;
                    testDiv.innerHTML += `<div style="color: #fca5a5; font-size: 0.85em; margin-left: 20px;">é”™è¯¯: ${error.message}</div>`;
                }
            } else {
                testDiv.innerHTML += `<div style="color: #f59e0b;">âš  3. Dashboard API: è·³è¿‡ï¼ˆéœ€è¦å…ˆç™»å½•ï¼‰</div>`;
            }
            
            testDiv.innerHTML += '<br><strong>æµ‹è¯•å®Œæˆ</strong>';
        }

        // è‡ªåŠ¨ç™»å½•
        async function autoLogin() {
            try {
                // å¦‚æœå·²ç»æœ‰tokenï¼Œå…ˆéªŒè¯ä¸€ä¸‹æ˜¯å¦æœ‰æ•ˆ
                if (CONFIG.token) {
                    try {
                        const response = await fetch(`${CONFIG.apiBaseUrl}/auth/me`, {
                            headers: {
                                'Authorization': `Bearer ${CONFIG.token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        if (response.ok) {
                            // tokenæœ‰æ•ˆï¼Œç›´æ¥è¿”å›
                            console.log('Tokenæœ‰æ•ˆï¼Œæ— éœ€é‡æ–°ç™»å½•');
                            return true;
                        }
                    } catch (error) {
                        console.log('TokenéªŒè¯å¤±è´¥ï¼Œå°†è‡ªåŠ¨ç™»å½•');
                    }
                }

                // å¦‚æœæ²¡æœ‰tokenæˆ–tokenæ— æ•ˆï¼Œæ‰§è¡Œè‡ªåŠ¨ç™»å½•
                console.log('å¼€å§‹è‡ªåŠ¨ç™»å½•...', {
                    username: CONFIG.autoLogin.username,
                    userType: CONFIG.autoLogin.userType,
                    apiUrl: `${CONFIG.apiBaseUrl}/auth/login`
                });
                
                const response = await fetch(`${CONFIG.apiBaseUrl}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: CONFIG.autoLogin.username,
                        password: CONFIG.autoLogin.password,
                        userType: CONFIG.autoLogin.userType
                    })
                });

                if (!response.ok) {
                    let errorMessage = `ç™»å½•å¤±è´¥: HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                        
                        // å¦‚æœæ˜¯ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼Œæä¾›æ›´è¯¦ç»†çš„æç¤º
                        if (errorData.message && errorData.message.includes('ç”¨æˆ·åæˆ–å¯†ç ')) {
                            errorMessage = `ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ã€‚è¯·æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„è‡ªåŠ¨ç™»å½•è´¦å·è®¾ç½®ï¼ˆç”¨æˆ·ååº”ä¸ºå·¥å·å¦‚ N001 æˆ–æ‰‹æœºå·å¦‚ 13800138000ï¼‰ã€‚`;
                        }
                    } catch (e) {
                        // å¦‚æœæ— æ³•è§£æé”™è¯¯å“åº”ï¼Œä½¿ç”¨é»˜è®¤é”™è¯¯ä¿¡æ¯
                        errorMessage = `ç™»å½•å¤±è´¥: HTTP ${response.status} ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                if (result.success && result.data && result.data.token) {
                    // ä¿å­˜token
                    CONFIG.token = result.data.token;
                    localStorage.setItem('token', result.data.token);
                    if (result.data.user) {
                        localStorage.setItem('userInfo', JSON.stringify(result.data.user));
                    }
                    console.log('è‡ªåŠ¨ç™»å½•æˆåŠŸ', {
                        username: CONFIG.autoLogin.username,
                        userId: result.data.user?.id
                    });
                    return true;
                } else {
                    throw new Error(result.message || 'ç™»å½•å¤±è´¥ï¼šæœªè¿”å›token');
                }
            } catch (error) {
                console.error('è‡ªåŠ¨ç™»å½•å¤±è´¥:', error);
                // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œæä¾›æ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    throw new Error('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨');
                }
                throw error;
            }
        }

        // åˆå§‹åŒ–
        async function init() {
            try {
                // å…ˆæ£€æŸ¥æœåŠ¡æ˜¯å¦å¯ç”¨
                console.log('æ£€æŸ¥åç«¯æœåŠ¡è¿æ¥...');
                try {
                    const healthCheck = await fetch(`${CONFIG.apiBaseUrl}/health`, {
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!healthCheck.ok) {
                        throw new Error(`å¥åº·æ£€æŸ¥å¤±è´¥: HTTP ${healthCheck.status}`);
                    }
                    
                    console.log('âœ“ åç«¯æœåŠ¡è¿æ¥æ­£å¸¸');
                } catch (error) {
                    console.error('âŒ åç«¯æœåŠ¡è¿æ¥å¤±è´¥:', error);
                    showError(`æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ (${CONFIG.apiBaseUrl})ã€‚\n\nè¯·ç¡®ä¿å·²å¯åŠ¨åç«¯æœåŠ¡ï¼š\n1. æ‰“å¼€ç»ˆç«¯/å‘½ä»¤è¡Œ\n2. è¿›å…¥ backend ç›®å½•\n3. è¿è¡Œ: npm start`);
                    return;
                }

                // è‡ªåŠ¨ç™»å½•
                console.log('å¼€å§‹è‡ªåŠ¨ç™»å½•...');
                await autoLogin();
                console.log('âœ“ è‡ªåŠ¨ç™»å½•æˆåŠŸ');

                // åˆ›å»ºç²’å­èƒŒæ™¯
                createParticles();

                // åˆå§‹åŒ–å›¾è¡¨
                initCharts();

                // åŠ è½½æ•°æ®
                await loadDashboardData();
                await loadDETStageStats();

                // å®šæ—¶åˆ·æ–°
                setInterval(() => {
                    loadDashboardData();
                    loadDETStageStats();
                }, CONFIG.refreshInterval);
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                showError(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', init);

        // æ‰‹åŠ¨åˆ·æ–°ï¼ˆæŒ‰F5æˆ–ç‚¹å‡»åˆ·æ–°æŒ‰é’®ï¼‰
        window.addEventListener('keydown', (e) => {
            if (e.key === 'F5') {
                e.preventDefault();
                loadDashboardData();
                loadDETStageStats();
            }
        });

        // æ³¨æ„ï¼šè‡ªåŠ¨ç™»å½•æ¨¡å¼ï¼Œæ— éœ€é€€å‡ºç™»å½•åŠŸèƒ½
        
        // å¼€å‘è€…è°ƒè¯•å·¥å…·ï¼šæ‰‹åŠ¨è¯Šæ–­ï¼ˆåœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œï¼‰
        window.diagnoseDashboard = async function() {
            console.log('%c=== Dashboard è¯Šæ–­å·¥å…· ===', 'color: #3b82f6; font-size: 16px; font-weight: bold;');
            console.log('');
            
            // 1. æ˜¾ç¤ºé…ç½®
            console.log('%c1. å½“å‰é…ç½®:', 'color: #10b981; font-weight: bold;');
            console.log('APIåœ°å€:', CONFIG.apiBaseUrl);
            console.log('è‡ªåŠ¨ç™»å½•ç”¨æˆ·å:', CONFIG.autoLogin.username);
            console.log('ç”¨æˆ·ç±»å‹:', CONFIG.autoLogin.userType);
            console.log('åˆ·æ–°é—´éš”:', CONFIG.refreshInterval, 'ms');
            console.log('');
            
            // 2. æµ‹è¯•å¥åº·æ£€æŸ¥
            console.log('%c2. æµ‹è¯•å¥åº·æ£€æŸ¥ API...', 'color: #10b981; font-weight: bold;');
            try {
                const healthResponse = await fetch(`${CONFIG.apiBaseUrl}/health`);
                const healthData = await healthResponse.json();
                console.log('âœ“ å¥åº·æ£€æŸ¥æˆåŠŸ:', healthData);
            } catch (error) {
                console.error('âœ— å¥åº·æ£€æŸ¥å¤±è´¥:', error.message);
                console.log('æç¤º: è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨');
                return;
            }
            console.log('');
            
            // 3. æµ‹è¯•ç™»å½•
            console.log('%c3. æµ‹è¯•ç™»å½• API...', 'color: #10b981; font-weight: bold;');
            try {
                const loginResponse = await fetch(`${CONFIG.apiBaseUrl}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: CONFIG.autoLogin.username,
                        password: CONFIG.autoLogin.password,
                        userType: CONFIG.autoLogin.userType
                    })
                });
                
                const loginData = await loginResponse.json();
                
                if (loginResponse.ok && loginData.success) {
                    console.log('âœ“ ç™»å½•æˆåŠŸ!');
                    console.log('Token:', loginData.data.token.substring(0, 50) + '...');
                    console.log('ç”¨æˆ·ä¿¡æ¯:', loginData.data.user);
                    
                    // ä¿å­˜token
                    localStorage.setItem('token', loginData.data.token);
                    CONFIG.token = loginData.data.token;
                } else {
                    console.error('âœ— ç™»å½•å¤±è´¥:', loginData.message || 'æœªçŸ¥é”™è¯¯');
                    console.log('å“åº”çŠ¶æ€:', loginResponse.status);
                    console.log('å®Œæ•´å“åº”:', loginData);
                    return;
                }
            } catch (error) {
                console.error('âœ— ç™»å½•è¯·æ±‚å¤±è´¥:', error.message);
                return;
            }
            console.log('');
            
            // 4. æµ‹è¯•Dashboard API
            console.log('%c4. æµ‹è¯• Dashboard API...', 'color: #10b981; font-weight: bold;');
            try {
                const dashboardResponse = await fetch(`${CONFIG.apiBaseUrl}/dashboard/stats`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.token}`
                    }
                });
                
                const dashboardData = await dashboardResponse.json();
                
                if (dashboardResponse.ok && dashboardData.success) {
                    console.log('âœ“ Dashboard API æˆåŠŸ!');
                    console.log('æ•°æ®æ¦‚è§ˆ:', {
                        æ€»æ‚£è€…æ•°: dashboardData.data.patientStats?.total_patients,
                        æ´»è·ƒæ‚£è€…: dashboardData.data.patientStats?.active_patients,
                        æ€»è¯„ä¼°: dashboardData.data.assessmentStats?.total_assessments,
                        ä»Šæ—¥è¯„ä¼°: dashboardData.data.assessmentStats?.today_assessments
                    });
                } else {
                    console.error('âœ— Dashboard API å¤±è´¥:', dashboardData.message || 'æœªçŸ¥é”™è¯¯');
                    console.log('å“åº”çŠ¶æ€:', dashboardResponse.status);
                    return;
                }
            } catch (error) {
                console.error('âœ— Dashboard è¯·æ±‚å¤±è´¥:', error.message);
                return;
            }
            console.log('');
            
            console.log('%c=== æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ ===', 'color: #10b981; font-size: 16px; font-weight: bold;');
            console.log('å»ºè®®: åˆ·æ–°é¡µé¢ä»¥åŠ è½½æ•°æ®');
        };
        
        // åœ¨æ§åˆ¶å°æç¤ºç”¨æˆ·
        console.log('%cğŸ’¡ æç¤º: å¦‚æœé¡µé¢æ— æ³•åŠ è½½ï¼Œè¯·åœ¨æ§åˆ¶å°è¿è¡Œ diagnoseDashboard() è¿›è¡Œè¯Šæ–­', 'color: #f59e0b; font-size: 14px;');
    </script>
</body>
</html>


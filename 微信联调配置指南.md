# 微信小程序联调配置指南

## 📋 目录

- [本地开发环境](#本地开发环境) - 快速开始本地调试
- [生产环境部署](#生产环境部署) - 部署到服务器

---

## 本地开发环境

### ⚡ 快速开始（推荐先从这里开始）

适合日常开发和调试，无需服务器和域名。

#### 1. 启动本地后端

```bash
cd backend

# 创建 .env 文件
# 内容：
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=你的MySQL密码
DB_NAME=stoma_care_db
JWT_SECRET=dev_secret_123
WECHAT_APPID=wx61ba15d015833945
WECHAT_SECRET=39dcc9d80a1ccbc94142d96519efad07
PORT=3000
NODE_ENV=development

# 安装依赖并启动
npm install
npm run init-db
npm run dev
```

#### 2. 配置小程序

修改 `patientApp/config.js` 或 `nurseApp/config.js`：

```javascript
module.exports = {
  apiBaseUrl: 'http://localhost:3000/api',  // 本地开发
  uploadUrl: 'http://localhost:3000/api/assessments/upload',
  timeout: 10000,
  version: '1.0.0'
}
```

#### 3. 微信开发者工具配置

1. 导入项目（`patientApp` 或 `nurseApp`）
2. **重要**：详情 → 本地设置 → 勾选：
   - ✅ **不校验合法域名、web-view（业务域名）、TLS版本以及HTTPS证书**
3. 点击"编译"开始调试

#### 4. 开始开发

- ✅ 修改代码，实时查看效果
- ✅ 查看控制台日志
- ✅ 查看 Network 网络请求
- ✅ 查看 Storage 存储数据

**详细指南**：查看 [快速开始本地开发.md](./快速开始本地开发.md)

---

## 生产环境部署

当开发完成，准备上线时，需要部署到服务器。

## ✅ 已完成的配置

### 1. 后端配置
- ✅ 微信 AppID: `wx61ba15d015833945`
- ✅ 微信 AppSecret: `39dcc9d80a1ccbc94142d96519efad07`
- ✅ 配置文件: `backend/.env` (需要手动创建)

### 2. 小程序端配置
- ✅ 患者端 AppID: `wx61ba15d015833945`
- ✅ 护士端 AppID: `wx61ba15d015833945`
- ✅ API配置文件已创建: `patientApp/config.js` 和 `nurseApp/config.js`
- ✅ 网络请求已优化，支持自动拼接API地址和错误处理

---

## 🔧 还需要完成的配置

### 步骤1: 创建后端环境变量文件

在 `backend` 目录下创建 `.env` 文件，填写以下内容：

```env
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_mysql_password
DB_NAME=stoma_care_db

# JWT密钥（请使用强随机字符串）
JWT_SECRET=your_strong_secret_key_here_123456789

# 微信小程序配置
WECHAT_APPID=wx61ba15d015833945
WECHAT_SECRET=39dcc9d80a1ccbc94142d96519efad07

# 服务器配置
PORT=3000
NODE_ENV=development
```

**注意**: 请修改 `DB_PASSWORD` 为您的实际MySQL密码。

### 步骤2: 初始化数据库

```bash
# 进入后端目录
cd backend

# 安装依赖（如果还没安装）
npm install

# 初始化数据库（会创建所有表和初始数据）
npm run init-db

# 启动后端服务
npm run dev
```

### 步骤3: 配置微信公众平台

登录 [微信公众平台](https://mp.weixin.qq.com/)，进行以下配置：

#### 3.1 配置服务器域名

在 **开发 > 开发管理 > 开发设置 > 服务器域名** 中配置：

**开发阶段（本地调试）:**
- ✅ 在微信开发者工具中勾选 "不校验合法域名、web-view（业务域名）、TLS版本以及HTTPS证书"

**生产部署阶段:**
- **request合法域名**: `https://your-domain.com`
- **uploadFile合法域名**: `https://your-domain.com`
- **downloadFile合法域名**: `https://your-domain.com`

#### 3.2 配置业务域名（可选）

如果使用web-view组件，需要配置业务域名。

#### 3.3 下载验证文件（生产环境）

配置服务器域名时，需要下载验证文件并放到服务器根目录。

### 步骤4: 微信开发者工具配置

#### 4.1 导入患者端小程序

1. 打开微信开发者工具
2. 选择 "小程序" > "导入项目"
3. 项目目录选择: `D:\wk\Code\Cursor\2025\StomaCareSystem\patientApp`
4. AppID 填写: `wx61ba15d015833945`
5. 项目名称: `造口护理-患者端`

#### 4.2 导入护士端小程序（如需要）

1. 新建一个微信开发者工具窗口
2. 项目目录选择: `D:\wk\Code\Cursor\2025\StomaCareSystem\nurseApp`
3. AppID 填写: `wx61ba15d015833945`（或护士端独立的AppID）
4. 项目名称: `造口护理-护士端`

#### 4.3 开发者工具设置

在微信开发者工具中：
1. 点击右上角 "详情"
2. 在 "本地设置" 中勾选：
   - ✅ 不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书
   - ✅ 启用调试
3. 确保后端服务正在运行（`http://localhost:3000`）

---

## 🧪 测试联调

### 1. 测试后端服务

打开浏览器访问: http://localhost:3000/api/health

应该看到类似这样的响应:
```json
{
  "status": "ok",
  "message": "服务运行正常"
}
```

### 2. 测试微信登录流程

在小程序中：
1. 打开患者端小程序
2. 点击 "一键登录" 按钮
3. 查看控制台日志，确认：
   - 获取到微信code
   - 成功调用后端登录接口
   - 获得JWT token
   - 登录成功

### 3. 测试API调用

在小程序页面中测试API调用，例如：

```javascript
// 示例：获取患者信息
const app = getApp()

app.request({
  url: '/patients/profile', // 会自动拼接为 http://localhost:3000/api/patients/profile
  method: 'GET'
}).then(res => {
  console.log('获取成功:', res)
}).catch(err => {
  console.error('获取失败:', err)
})
```

---

## 📋 常见问题

### Q1: 小程序提示 "不在以下 request 合法域名列表中"

**解决方案**: 
- 开发阶段：在微信开发者工具中勾选 "不校验合法域名"
- 生产环境：在微信公众平台配置服务器域名

### Q2: 微信登录失败，提示 "微信登录失败: invalid code"

**可能原因**:
1. AppID 或 AppSecret 配置错误
2. code 已经被使用过（一个 code 只能用一次）
3. code 已过期（5分钟有效期）

**解决方案**: 
- 检查 `backend/.env` 中的 WECHAT_APPID 和 WECHAT_SECRET
- 确保每次登录都重新获取 code

### Q3: 网络请求失败

**检查清单**:
- ✅ 后端服务是否正在运行
- ✅ API 地址配置是否正确（`patientApp/config.js`）
- ✅ 网络连接是否正常
- ✅ 防火墙是否拦截了3000端口

### Q4: Token过期怎么办

系统已自动处理Token过期：
- 当接收到401状态码时，自动清除本地存储
- 提示用户重新登录
- 自动跳转到登录页面

### Q5: 如何查看请求日志

**后端日志**:
- 查看运行 `npm run dev` 的终端窗口
- 所有API请求都会打印日志

**小程序日志**:
- 打开微信开发者工具的 "控制台" 面板
- 查看 console.log 输出

---

## 🚀 生产环境部署

当开发完成后，需要进行以下调整：

### 1. 修改小程序配置

编辑 `patientApp/config.js` 和 `nurseApp/config.js`:

```javascript
module.exports = {
  // 使用生产环境API地址
  apiBaseUrl: 'https://your-domain.com/api',
  
  // 其他配置...
}
```

### 2. 部署后端服务

1. 购买服务器和域名
2. 配置HTTPS证书（必须）
3. 使用 PM2 部署后端
4. 配置 Nginx 反向代理

### 3. 配置微信公众平台

1. 添加服务器域名白名单
2. 下载并上传域名验证文件
3. 提交小程序审核

---

## 📞 技术支持

如遇到问题：
1. 查看后端日志: 终端窗口
2. 查看小程序日志: 开发者工具控制台
3. 检查配置文件是否正确
4. 参考 `backend/API.md` 查看接口文档

---

## ✨ 开始联调！

现在您可以开始微信小程序的联调了！

**开始步骤**:
1. ✅ 确保 `backend/.env` 文件已创建并配置正确
2. ✅ 启动后端: `cd backend && npm run dev`
3. ✅ 打开微信开发者工具，导入患者端或护士端项目
4. ✅ 勾选 "不校验合法域名"
5. ✅ 开始调试！

祝您开发顺利！🎉


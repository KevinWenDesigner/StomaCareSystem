<!--patient-app/pages/education/diet-study/diet-study.wxml-->
<view class="container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <view class="header-left" bindtap="goBack">
      <text class="back-icon">â†</text>
    </view>
    <text class="page-title">{{course.title}}</text>
    <view class="header-right"></view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-state">
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- é¥®é£ŸæŒ‡å¯¼å­¦ä¹ å†…å®¹ -->
  <view wx:else class="study-content">
    <!-- å­¦ä¹ è¿›åº¦ -->
    <view class="progress-section">
      <view class="progress-header">
        <text class="progress-title">å­¦ä¹ è¿›åº¦</text>
        <text class="progress-percent">{{studyProgress}}%</text>
      </view>
      
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{studyProgress}}%"></view>
      </view>
      
      <text class="progress-text">å·²å®Œæˆ {{studyProgress}}%</text>
    </view>

    <!-- å½“å‰ç« èŠ‚ -->
    <view wx:if="{{course.chapters && course.chapters[currentChapter]}}" class="chapter-section">
      <view class="chapter-header">
        <text class="chapter-title">ç¬¬{{currentChapter + 1}}ç« ï¼š{{course.chapters[currentChapter].title}}</text>
        <text class="chapter-duration">{{course.chapters[currentChapter].duration}}</text>
      </view>
      
      <view class="chapter-content">
        <view class="content-card">
          <text class="content-title">é¥®é£ŸæŒ‡å¯¼</text>
          <text class="content-text">
            è¿™é‡Œæ˜¯ç¬¬{{currentChapter + 1}}ç« çš„é¥®é£ŸæŒ‡å¯¼å†…å®¹ã€‚è¯·ä»”ç»†å­¦ä¹ ä»¥ä¸‹è¥å…»çŸ¥è¯†å’Œé¥®é£Ÿå»ºè®®ï¼Œå®Œæˆåç‚¹å‡»"å®Œæˆå­¦ä¹ "æŒ‰é’®ã€‚
          </text>
          
          <!-- è¥å…»çŸ¥è¯† -->
          <view class="nutrition-knowledge">
            <view class="knowledge-item">
              <text class="knowledge-icon">ğŸ</text>
              <text class="knowledge-text">è¥å…»å‡è¡¡æ˜¯é€ å£æ‚£è€…å¥åº·çš„åŸºç¡€</text>
            </view>
            <view class="knowledge-item">
              <text class="knowledge-icon">ğŸ¥©</text>
              <text class="knowledge-text">ä¼˜è´¨è›‹ç™½è´¨æœ‰åŠ©äºä¼¤å£æ„ˆåˆ</text>
            </view>
            <view class="knowledge-item">
              <text class="knowledge-icon">ğŸ¥¬</text>
              <text class="knowledge-text">é€‚é‡è†³é£Ÿçº¤ç»´ä¿ƒè¿›è‚ é“å¥åº·</text>
            </view>
            <view class="knowledge-item">
              <text class="knowledge-icon">ğŸ’§</text>
              <text class="knowledge-text">å……è¶³æ°´åˆ†æ‘„å…¥é¢„é˜²è„±æ°´</text>
            </view>
          </view>
          
          <!-- é¥®é£Ÿå»ºè®® -->
          <view class="diet-tips">
            <text class="tips-title">ğŸ’¡ é¥®é£Ÿå»ºè®®</text>
            <view class="tips-list">
              <text class="tip-item">â€¢ é€‰æ‹©æ˜“æ¶ˆåŒ–çš„é£Ÿç‰©</text>
              <text class="tip-item">â€¢ é¿å…åˆºæ¿€æ€§é£Ÿç‰©</text>
              <text class="tip-item">â€¢ å°‘é‡å¤šé¤</text>
              <text class="tip-item">â€¢ æ³¨æ„é£Ÿç‰©å«ç”Ÿ</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç« èŠ‚åˆ—è¡¨ -->
    <view wx:if="{{course.chapters}}" class="chapters-section">
      <view class="section-header">
        <text class="section-title">é¥®é£Ÿç« èŠ‚</text>
        <text class="section-subtitle">å…±{{course.chapters.length}}ä¸ªç« èŠ‚</text>
      </view>
      
      <view class="chapters-list">
        <view wx:for="{{course.chapters}}" wx:key="id" 
              class="chapter-item {{index === currentChapter ? 'active' : ''}} {{item.completed ? 'completed' : ''}}"
              bindtap="startChapter" data-index="{{index}}">
          <view class="chapter-info">
            <view class="chapter-header">
              <text class="chapter-number">ç¬¬{{item.id}}ç« </text>
              <text class="chapter-duration">{{item.duration}}</text>
            </view>
            <text class="chapter-title">{{item.title}}</text>
          </view>
          
          <view class="chapter-status">
            <text wx:if="{{item.completed}}" class="status-completed">å·²å®Œæˆ</text>
            <text wx:elif="{{index === currentChapter}}" class="status-current">å­¦ä¹ ä¸­</text>
            <text wx:else class="status-pending">å¾…å­¦ä¹ </text>
          </view>
        </view>
      </view>
    </view>

    <!-- è¥å…»è®¡ç®—å™¨å¼¹çª— -->
    <view wx:if="{{showNutritionCalculator}}" class="calculator-modal">
      <view class="modal-overlay" bindtap="closeNutritionCalculator"></view>
      <view class="modal-content">
        <view class="calculator-header">
          <text class="calculator-title">ğŸ è¥å…»éœ€æ±‚è®¡ç®—</text>
          <text class="calculator-subtitle">æ ¹æ®æ‚¨çš„èº«ä½“æƒ…å†µè®¡ç®—è¥å…»éœ€æ±‚</text>
        </view>
        
        <view class="calculator-content">
          <!-- åŸºæœ¬ä¿¡æ¯è¾“å…¥ -->
          <view class="input-section">
            <view class="input-item">
              <text class="input-label">ä½“é‡ (kg)</text>
              <input class="input-field" type="digit" value="{{nutritionData.weight}}" 
                     data-field="weight" bindinput="updateNutritionData" placeholder="è¯·è¾“å…¥ä½“é‡"/>
            </view>
            <view class="input-item">
              <text class="input-label">èº«é«˜ (cm)</text>
              <input class="input-field" type="digit" value="{{nutritionData.height}}" 
                     data-field="height" bindinput="updateNutritionData" placeholder="è¯·è¾“å…¥èº«é«˜"/>
            </view>
            <view class="input-item">
              <text class="input-label">å¹´é¾„</text>
              <input class="input-field" type="digit" value="{{nutritionData.age}}" 
                     data-field="age" bindinput="updateNutritionData" placeholder="è¯·è¾“å…¥å¹´é¾„"/>
            </view>
            <view class="input-item">
              <text class="input-label">æ´»åŠ¨æ°´å¹³</text>
              <picker class="input-field" mode="selector" range="{{['ä¹…åä¸åŠ¨', 'è½»åº¦æ´»åŠ¨', 'ä¸­åº¦æ´»åŠ¨', 'é‡åº¦æ´»åŠ¨', 'æé‡åº¦æ´»åŠ¨']}}" 
                      range-key="name" value="{{0}}" bindchange="updateActivityLevel">
                <text class="picker-text">{{nutritionData.activityText || 'è¯·é€‰æ‹©æ´»åŠ¨æ°´å¹³'}}</text>
              </picker>
            </view>
          </view>
          
          <!-- è®¡ç®—ç»“æœ -->
          <view wx:if="{{nutritionData.dailyCalories > 0}}" class="result-section">
            <text class="result-title">è®¡ç®—ç»“æœ</text>
            <view class="result-grid">
              <view class="result-item">
                <text class="result-label">åŸºç¡€ä»£è°¢ç‡</text>
                <text class="result-value">{{nutritionData.bmr}} åƒå¡</text>
              </view>
              <view class="result-item">
                <text class="result-label">æ¯æ—¥çƒ­é‡éœ€æ±‚</text>
                <text class="result-value">{{nutritionData.dailyCalories}} åƒå¡</text>
              </view>
              <view class="result-item">
                <text class="result-label">è›‹ç™½è´¨</text>
                <text class="result-value">{{nutritionData.protein}}g</text>
              </view>
              <view class="result-item">
                <text class="result-label">ç¢³æ°´åŒ–åˆç‰©</text>
                <text class="result-value">{{nutritionData.carbs}}g</text>
              </view>
              <view class="result-item">
                <text class="result-label">è„‚è‚ª</text>
                <text class="result-value">{{nutritionData.fat}}g</text>
              </view>
            </view>
          </view>
          
          <view class="calculator-options">
            <button class="calculator-btn primary" bindtap="calculateNutrition">
              <text class="btn-text">è®¡ç®—è¥å…»éœ€æ±‚</text>
            </button>
            <button class="calculator-btn secondary" bindtap="showRecipeRecommendation">
              <text class="btn-text">æŸ¥çœ‹é£Ÿè°±æ¨è</text>
            </button>
            <button class="calculator-btn secondary" bindtap="closeNutritionCalculator">
              <text class="btn-text">å…³é—­</text>
            </button>
          </view>
        </view>
      </view>
    </view>

    <!-- é£Ÿè°±æ¨èå¼¹çª— -->
    <view wx:if="{{showRecipeRecommendation}}" class="recipe-modal">
      <view class="modal-overlay" bindtap="closeRecipeRecommendation"></view>
      <view class="modal-content">
        <view class="recipe-header">
          <text class="recipe-title">ğŸ½ï¸ é£Ÿè°±æ¨è</text>
          <text class="recipe-subtitle">é€‚åˆé€ å£æ‚£è€…çš„è¥å…»é£Ÿè°±</text>
        </view>
        
        <view class="recipe-content">
          <view wx:for="{{recipeRecommendations}}" wx:key="meal" class="recipe-item">
            <view class="recipe-meal">
              <text class="meal-title">{{item.meal}}</text>
              <text class="meal-subtitle">{{item.title}}</text>
            </view>
            
            <text class="recipe-desc">{{item.description}}</text>
            
            <view class="food-list">
              <view wx:for="{{item.foods}}" wx:key="name" wx:for-item="food" class="food-item">
                <text class="food-name">{{food.name}}</text>
                <text class="food-amount">{{food.amount}}</text>
                <text class="food-calories">{{food.calories}}åƒå¡</text>
              </view>
            </view>
            
            <view class="recipe-summary">
              <text class="total-calories">æ€»çƒ­é‡ï¼š{{item.totalCalories}}åƒå¡</text>
              <text class="recipe-tips">{{item.tips}}</text>
            </view>
          </view>
          
          <button class="recipe-btn" bindtap="closeRecipeRecommendation">
            <text class="btn-text">å…³é—­</text>
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
  <view class="bottom-actions">
    <button wx:if="{{!isCompleted && course.chapters && course.chapters[currentChapter] && !showNutritionCalculator}}" 
            class="action-btn primary" bindtap="completeChapter">
      <text class="btn-text">å®Œæˆå­¦ä¹ </text>
    </button>
    <button wx:else class="action-btn secondary" bindtap="goBack">
      <text class="btn-text">è¿”å›è¯¾ç¨‹</text>
    </button>
  </view>
</view> 
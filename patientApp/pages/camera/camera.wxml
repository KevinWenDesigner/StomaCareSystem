<!--patient-app/pages/camera/camera.wxml-->
<view class="container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <text class="page-title">AIæ™ºèƒ½è¯„ä¼°</text>
    <text class="page-subtitle">æ‹ç…§è·å¾—ä¸“ä¸šè¯„ä¼°å»ºè®®</text>
  </view>

  <!-- æ‹ç…§åŒºåŸŸ -->
  <view class="camera-section">
    <view class="camera-preview">
      <view wx:if="{{!photoPath}}" class="camera-placeholder">
        <text class="camera-icon">ğŸ“·</text>
        <text class="camera-tip">ç‚¹å‡»æ‹ç…§å¼€å§‹è¯„ä¼°</text>
        <text class="camera-subtip">å»ºè®®åœ¨å…‰çº¿å……è¶³çš„ç¯å¢ƒä¸‹æ‹æ‘„</text>
      </view>
      <image wx:else src="{{photoPath}}" mode="aspectFit" class="camera-image"></image>
    </view>
    
    <view class="camera-actions">
      <button class="camera-btn" bindtap="takePhoto">
        <text class="btn-text">æ‹ç…§è¯„ä¼°</text>
      </button>
      <button class="camera-btn outline" bindtap="chooseImage">
        <text class="btn-text">é€‰æ‹©ç…§ç‰‡</text>
      </button>
      <button wx:if="{{photoPath && assessmentResult}}" class="camera-btn save-btn" bindtap="savePhotoToAlbum">
        <text class="btn-text">ğŸ’¾ ä¿å­˜ç…§ç‰‡</text>
      </button>
    </view>
  </view>

  <!-- AIåˆ†æè¿›åº¦ -->
  <view wx:if="{{isAnalyzing}}" class="analysis-section">
    <view class="analysis-card">
      <!-- åœ†å½¢è¿›åº¦æŒ‡ç¤ºå™¨ -->
      <view class="circular-progress">
        <view class="progress-ring">
          <text class="progress-percent">{{analysisProgress}}%</text>
          <text class="progress-label">åˆ†æä¸­</text>
        </view>
        <view class="scanning-line"></view>
      </view>
      
      <!-- å½“å‰æ­¥éª¤æ˜¾ç¤º -->
      <view class="current-step">
        <text class="step-icon-large">{{currentStep > 0 && analysisSteps[currentStep - 1] ? analysisSteps[currentStep - 1].icon : 'ğŸ¤–'}}</text>
        <text class="step-text-large">{{currentStepText || 'AIåˆ†æä¸­...'}}</text>
      </view>
      
      <!-- è¿›åº¦æ¡ -->
      <view class="progress-bar-wrapper">
        <view class="progress-bar">
          <view class="progress-fill" style="width: {{analysisProgress}}%"></view>
          <view class="progress-glow" style="left: {{analysisProgress}}%"></view>
        </view>
      </view>
      
      <!-- åˆ†ææ­¥éª¤åˆ—è¡¨ -->
      <view class="analysis-steps-list">
        <view wx:for="{{analysisSteps}}" wx:key="id" 
              class="step-item-v2 {{currentStep >= item.id ? 'active' : ''}} {{currentStep > item.id ? 'completed' : ''}}">
          <view class="step-dot">
            <text class="step-check" wx:if="{{currentStep > item.id}}">âœ“</text>
          </view>
          <text class="step-icon-small">{{item.icon}}</text>
          <text class="step-text-small">{{item.text}}</text>
        </view>
      </view>
      
      <!-- åˆ†ææç¤º -->
      <view class="analysis-tips">
        <text class="tip-icon">ğŸ’¡</text>
        <text class="tip-text">AIæ­£åœ¨ä½¿ç”¨æ·±åº¦å­¦ä¹ ç®—æ³•åˆ†æé€ å£å›¾åƒ...</text>
      </view>
    </view>
  </view>

  <!-- è¯„ä¼°ç»“æœ -->
  <view wx:if="{{assessmentResult}}" class="result-section">
    <view class="section-header">
      <text class="section-title">è¯„ä¼°ç»“æœ</text>
      <text class="section-subtitle">{{assessmentTime}}</text>
    </view>
    
    <view class="result-card">
      <view class="result-header">
        <text class="result-title">{{assessmentResult.woundTypeText || 'é€ å£'}}çŠ¶æ€è¯„ä¼°</text>
        <view class="result-score score-{{assessmentResult.level}}">
          <text class="score-text">{{assessmentResult.score}}åˆ†</text>
        </view>
      </view>
      
      <!-- é€šä¹‰åƒé—®è¯¦ç»†åˆ†æ -->
      <view class="qwen-analysis">
        <view class="analysis-item">
          <text class="analysis-label">ğŸ¨ {{assessmentResult.woundTypeText || 'é€ å£'}}é¢œè‰²</text>
          <text class="analysis-value">{{assessmentResult.description}}</text>
        </view>
        
        <view class="analysis-item" wx:if="{{assessmentResult.stomaSize}}">
          <text class="analysis-label">ğŸ“ {{assessmentResult.woundTypeText || 'é€ å£'}}å¤§å°</text>
          <text class="analysis-value">{{assessmentResult.stomaSize}}</text>
        </view>
        
        <view class="analysis-item" wx:if="{{assessmentResult.skinCondition}}">
          <text class="analysis-label">ğŸ‘ï¸ å‘¨å›´çš®è‚¤çŠ¶å†µ</text>
          <text class="analysis-value">{{assessmentResult.skinCondition}}</text>
        </view>
        
        <!-- é—®é¢˜åˆ—è¡¨ -->
        <view class="analysis-item" wx:if="{{assessmentResult.issues && assessmentResult.issues.length > 0}}">
          <text class="analysis-label">âš ï¸ å‘ç°é—®é¢˜</text>
          <text class="analysis-value">{{assessmentResult.issuesText}}</text>
        </view>
        
        <!-- AIç½®ä¿¡åº¦ -->
        <view class="analysis-item" wx:if="{{assessmentResult.confidence}}">
          <text class="analysis-label">ğŸ¤– AIç½®ä¿¡åº¦</text>
          <text class="analysis-value">{{assessmentResult.confidence * 100}}%</text>
        </view>
      </view>
      
      <!-- AIåˆ†ææŒ‡æ ‡ -->
      <view class="analysis-metrics">
        <view class="metric-item">
          <text class="metric-label">å‘çº¢ç¨‹åº¦</text>
          <view class="metric-bar">
            <view class="metric-fill" style="width: {{assessmentResult.analysis.redness}}%"></view>
          </view>
          <text class="metric-value">{{assessmentResult.analysis.redness}}%</text>
        </view>
        
        <view class="metric-item">
          <text class="metric-label">è‚¿èƒ€ç¨‹åº¦</text>
          <view class="metric-bar">
            <view class="metric-fill" style="width: {{assessmentResult.analysis.swelling}}%"></view>
          </view>
          <text class="metric-value">{{assessmentResult.analysis.swelling}}%</text>
        </view>
        
        <view class="metric-item">
          <text class="metric-label">æ„ŸæŸ“é£é™©</text>
          <view class="metric-bar">
            <view class="metric-fill" style="width: {{assessmentResult.analysis.infection}}%"></view>
          </view>
          <text class="metric-value">{{assessmentResult.analysis.infection}}%</text>
        </view>
        
        <view class="metric-item">
          <text class="metric-label">æ„ˆåˆç¨‹åº¦</text>
          <view class="metric-bar">
            <view class="metric-fill" style="width: {{assessmentResult.analysis.healing}}%"></view>
          </view>
          <text class="metric-value">{{assessmentResult.analysis.healing}}%</text>
        </view>
      </view>
      
      <view class="result-details">
        <view class="detail-item">
          <text class="detail-label">è¯„ä¼°ç­‰çº§</text>
          <text class="detail-value">{{assessmentResult.levelText}}</text>
        </view>
        <view class="detail-item" wx:if="{{assessmentResult.pressureStageText}}">
          <text class="detail-label">NPUAP åˆ†æœŸ</text>
          <text class="detail-value pressure-stage-{{assessmentResult.pressureStage}}">{{assessmentResult.pressureStageText}}</text>
        </view>
        <view class="detail-item detail-item-full">
          <text class="detail-label">ğŸ¤– AIè¯¦ç»†åˆ†æ</text>
          <text class="detail-value detail-analysis">{{assessmentResult.attention}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å†å²è®°å½• -->
  <view class="history-section">
    <view class="section-header">
      <text class="section-title">å†å²è¯„ä¼°</text>
      <button class="view-all-btn" bindtap="viewHistory">
        <text class="btn-text">æŸ¥çœ‹å…¨éƒ¨</text>
      </button>
    </view>
    
    <view wx:if="{{historyList.length === 0}}" class="empty-state">
      <text class="empty-icon">ğŸ“Š</text>
      <text class="empty-text">æš‚æ— è¯„ä¼°è®°å½•</text>
      <text class="empty-subtext">å¼€å§‹æ‹ç…§è¯„ä¼°ï¼Œè®°å½•æ‚¨çš„é€ å£çŠ¶æ€</text>
    </view>
    
    <view wx:else class="history-list">
      <view wx:for="{{historyList}}" wx:key="id" class="history-item">
        <view class="history-card">
          <image src="{{item.photoPath}}" mode="aspectFill" class="history-image"></image>
          <view class="history-content">
            <text class="history-time">{{item.time}}</text>
            <text class="history-score">è¯„åˆ†: {{item.score}}åˆ†</text>
            <text class="history-level">{{item.levelText}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view> 
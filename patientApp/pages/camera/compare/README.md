# AI评估历史对比功能说明

## 📋 功能概述

本次更新为患者端小程序的AI评估功能增加了**历史对比**能力，允许患者选择多个评估记录进行对比分析，直观地查看造口恢复趋势。

## ✨ 主要功能

### 1. 多选对比模式
- **位置**：历史评估记录页面（`pages/camera/history/history`）
- **入口**：点击"📊 对比评估"按钮进入对比模式
- **选择方式**：点击评估记录卡片左侧的复选框
- **选择限制**：最少2条，最多5条记录
- **操作提示**：实时显示已选择数量和操作提示

### 2. 详细对比页面
**位置**：`pages/camera/compare/compare`

#### 2.1 双记录对比
当选择2条记录时，提供详细的对比分析：

##### 整体评估
- 🎉 恢复状态评级（恢复良好/稳步恢复/状态稳定/需要关注/需要处理）
- ⏱️ 时间跨度显示
- 💬 智能评估描述

##### 图片对比
- 📸 并排展示初始状态和当前状态
- 🔍 点击图片可预览放大
- 📊 显示评分变化

##### 健康指标对比
使用进度条直观对比以下指标：
- **红肿程度**：显示前后变化及改善/恶化百分比
- **肿胀程度**：显示前后变化及改善/恶化百分比
- **感染风险**：显示前后变化及改善/恶化百分比
- **愈合程度**：显示前后变化及改善/恶化百分比

每个指标都包含：
- ✅ 绿色：指标改善
- ⚠️ 红色：指标恶化
- ➖ 黄色：指标稳定

##### 护理建议
根据对比结果智能生成个性化护理建议：
- 红肿增加时的护理提示
- 感染风险上升的预警
- 愈合良好的鼓励建议
- 整体恢复效果的评价

#### 2.2 趋势分析
当选择多条记录时，显示趋势图表：

##### 周期选择
- 近7天
- 近30天
- 近90天

##### 趋势图表
- 📈 健康评分趋势线
- 📊 多指标对比条形图
- 🎨 彩色图例区分不同指标

##### 统计摘要
- 评估总次数
- 平均评分
- 改善幅度

### 3. 数据可视化
- **进度条**：使用渐变色彩的进度条展示各项指标
- **趋势图**：简化的折线图和柱状图展示变化趋势
- **颜色编码**：
  - 🔵 蓝紫渐变：健康评分
  - 🔴 红色：红肿程度
  - 🟠 橙色：感染风险
  - 🟢 绿色：愈合程度

## 🎨 UI/UX 设计亮点

### 视觉设计
1. **渐变主题色**：使用紫蓝渐变（#667eea → #764ba2）作为主色调
2. **卡片式布局**：圆角卡片配合阴影，层次分明
3. **动画效果**：
   - 对比模式切换时的滑入动画
   - 进度条的缓动动画
   - 按钮的过渡效果

### 交互设计
1. **明确的操作反馈**：
   - 选择时复选框高亮
   - 按钮禁用/启用状态清晰
   - Toast提示及时准确

2. **防误操作**：
   - 对比模式下禁用详情查看
   - 最大选择数量限制
   - 操作前二次确认

3. **便捷的导航**：
   - 标签页切换（详细对比/趋势分析）
   - 一键返回历史记录
   - 图片预览功能

## 📱 页面结构

```
patientApp/pages/camera/
├── camera.js              # AI评估主页面
├── camera.wxml
├── camera.wxss
├── history/              # 历史记录页面
│   ├── history.js        # ✨ 新增对比模式逻辑
│   ├── history.wxml      # ✨ 新增对比UI
│   ├── history.wxss      # ✨ 新增对比样式
│   └── history.json
└── compare/              # ✨ 新增对比页面
    ├── compare.js        # 对比逻辑
    ├── compare.wxml      # 对比UI
    ├── compare.wxss      # 对比样式
    ├── compare.json      # 页面配置
    └── README.md         # 本文档
```

## 💻 技术实现

### 数据流
1. **选择阶段**：在`history.js`中维护`selectedRecords`数组
2. **传递阶段**：通过`app.globalData.selectedAssessments`传递选中数据
3. **对比阶段**：在`compare.js`中处理和计算对比数据

### 关键算法

#### 整体评估算法
```javascript
improvementScore = 
  (红肿降低) + (肿胀降低) + (感染降低) + (愈合增加)

if (improvementScore > 30) → "恢复良好"
if (improvementScore > 0) → "稳步恢复"  
if (improvementScore === 0) → "状态稳定"
if (improvementScore > -30) → "需要关注"
else → "需要处理"
```

#### 指标差异计算
```javascript
diff = {
  value: Math.abs(after - before),
  isImproved: after < before, // 对于负面指标
  isWorse: after > before,
  noChange: after === before
}
```

### 性能优化
- 使用本地缓存减少API调用
- 懒加载趋势数据
- 图片预加载优化

## 🔄 使用流程

1. **进入历史记录页面**
   - 从AI评估页面点击"查看历史"
   - 或从首页进入

2. **开启对比模式**
   - 点击"📊 对比评估"按钮
   - 页面进入多选模式

3. **选择评估记录**
   - 点击记录卡片左侧的复选框
   - 可选择2-5条记录

4. **开始对比**
   - 点击底部"开始对比"按钮
   - 自动跳转到对比页面

5. **查看对比结果**
   - 查看整体评估
   - 对比图片和指标
   - 阅读护理建议

6. **切换趋势分析**
   - 点击"趋势分析"标签
   - 选择时间周期
   - 查看图表和统计

7. **生成报告（开发中）**
   - 点击"生成报告"按钮
   - 等待后续功能上线

## 🎯 未来优化方向

### 短期优化
1. ✅ 添加图表库支持（如ECharts for 小程序）
2. ✅ 实现PDF报告导出
3. ✅ 支持分享给医护人员
4. ✅ 添加打印功能

### 中期优化
1. AI智能分析报告
2. 与护理计划联动
3. 异常情况自动提醒
4. 家属同步查看

### 长期规划
1. 多维度数据对比（结合日记、用药等）
2. 同类患者匿名化对比
3. 恢复预测模型
4. 3D可视化展示

## 📝 注意事项

1. **数据来源**：对比数据来自本地缓存和后端API
2. **网络依赖**：首次加载需要网络，后续可使用缓存
3. **兼容性**：支持微信小程序基础库 2.0+
4. **权限要求**：无特殊权限要求

## 🐛 已知问题

暂无

## 🔧 修复记录

### 2025-11-07 - 修复多条记录对比问题
**问题描述**：当选择超过2条历史记录进行对比时，系统不返回对比结果

**原因分析**：
- `compare.js` 中的 `prepareComparisonData()` 方法只处理恰好2条记录的情况
- 条件判断为 `if (records.length === 2)`，导致3条或更多记录时不生成对比数据
- `comparisonData` 保持为 `null`，UI无法显示对比结果

**修复方案**：
1. 将条件从 `records.length === 2` 改为 `records.length >= 2`
2. 对比逻辑改为：对比第一条（最早）和最后一条（最新）记录
3. 在UI头部添加提示，显示选中了多少条记录
4. 区分2条记录和多条记录的提示文本

**修复内容**：
- ✅ `compare.js`: 修改 `prepareComparisonData()` 方法支持2条或更多记录
- ✅ `compare.wxml`: 更新头部subtitle，智能显示记录数量和对比说明
- ✅ 趋势分析功能保持不变，已支持任意数量记录

**测试建议**：
1. 选择2条记录对比 - 应显示"对比2条评估记录"
2. 选择3条记录对比 - 应显示"共3条记录，对比首末变化"
3. 选择5条记录对比 - 应显示详细对比和趋势图表
4. 验证对比的是第一条和最后一条记录
5. 验证趋势分析标签页显示所有选中记录

## 📞 技术支持

如有问题或建议，请联系开发团队。

---

**版本**：v1.0.0  
**更新日期**：2025-11-07  
**开发者**：造口护理系统开发团队


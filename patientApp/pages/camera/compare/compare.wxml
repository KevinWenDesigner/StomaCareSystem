<!--patient-app/pages/camera/compare/compare.wxml-->
<view class="container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="header">
    <view class="header-title">
      <text class="title">è¯„ä¼°å¯¹æ¯”</text>
      <text class="subtitle" wx:if="{{selectedRecords.length === 2}}">å¯¹æ¯”2æ¡è¯„ä¼°è®°å½•</text>
      <text class="subtitle" wx:else>å…±{{selectedRecords.length}}æ¡è®°å½•ï¼Œå¯¹æ¯”é¦–æœ«å˜åŒ–</text>
    </view>
    <view class="header-actions">
      <view class="action-btn" bindtap="generateReport">
        <text class="icon">ğŸ“„</text>
        <text class="text">ç”ŸæˆæŠ¥å‘Š</text>
      </view>
    </view>
  </view>

  <!-- æ ‡ç­¾åˆ‡æ¢ -->
  <view class="tabs">
    <view 
      class="tab-item {{activeTab === 'detail' ? 'active' : ''}}"
      data-tab="detail"
      bindtap="switchTab"
    >
      <text class="tab-text">è¯¦ç»†å¯¹æ¯”</text>
    </view>
    <view 
      class="tab-item {{activeTab === 'trend' ? 'active' : ''}}"
      data-tab="trend"
      bindtap="switchTab"
    >
      <text class="tab-text">è¶‹åŠ¿åˆ†æ</text>
    </view>
  </view>

  <!-- è¯¦ç»†å¯¹æ¯”å†…å®¹ -->
  <scroll-view 
    wx:if="{{activeTab === 'detail' && comparisonData}}"
    class="content"
    scroll-y
    enable-back-to-top
  >
    <!-- æ•´ä½“è¯„ä¼° -->
    <view class="overall-card">
      <view class="overall-icon" style="background: {{comparisonData.overallAssessment.color}}20;">
        <text class="icon-text">{{comparisonData.overallAssessment.icon}}</text>
      </view>
      <view class="overall-content">
        <view class="overall-title" style="color: {{comparisonData.overallAssessment.color}};">
          {{comparisonData.overallAssessment.text}}
        </view>
        <view class="overall-desc">{{comparisonData.overallAssessment.description}}</view>
        <view class="overall-time">
          <text class="label">å¯¹æ¯”æ—¶é—´è·¨åº¦ï¼š</text>
          <text class="value">{{comparisonData.timeDiff}}</text>
        </view>
      </view>
    </view>

    <!-- å›¾ç‰‡å¯¹æ¯” -->
    <view class="comparison-section">
      <view class="section-title">
        <text class="icon">ğŸ“¸</text>
        <text class="text">å›¾ç‰‡å¯¹æ¯”</text>
      </view>
      <view class="image-comparison">
        <view class="image-item">
          <view class="image-label">
            <text class="label-text">åˆå§‹çŠ¶æ€</text>
            <text class="label-date">{{comparisonData.record1.formattedDate}}</text>
          </view>
          <image 
            class="comparison-image"
            src="{{comparisonData.record1.photoPath}}"
            mode="aspectFill"
            bindtap="previewImage"
            data-index="0"
          />
          <view class="image-score">
            <text class="score-text">{{comparisonData.record1.score}}åˆ†</text>
          </view>
        </view>
        
        <view class="image-divider">
          <view class="divider-line"></view>
          <view class="divider-icon">â†’</view>
          <view class="divider-line"></view>
        </view>

        <view class="image-item">
          <view class="image-label">
            <text class="label-text">å½“å‰çŠ¶æ€</text>
            <text class="label-date">{{comparisonData.record2.formattedDate}}</text>
          </view>
          <image 
            class="comparison-image"
            src="{{comparisonData.record2.photoPath}}"
            mode="aspectFill"
            bindtap="previewImage"
            data-index="1"
          />
          <view class="image-score">
            <text class="score-text">{{comparisonData.record2.score}}åˆ†</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æŒ‡æ ‡å¯¹æ¯” -->
    <view class="comparison-section">
      <view class="section-title">
        <text class="icon">ğŸ“Š</text>
        <text class="text">å¥åº·æŒ‡æ ‡å¯¹æ¯”</text>
      </view>

      <!-- çº¢è‚¿ç¨‹åº¦ -->
      <view class="metric-item">
        <view class="metric-header">
          <text class="metric-name">çº¢è‚¿ç¨‹åº¦</text>
          <view class="metric-change {{comparisonData.metrics.redness.diff.isImproved ? 'improved' : comparisonData.metrics.redness.diff.isWorse ? 'worse' : 'stable'}}">
            <text class="change-icon">
              {{comparisonData.metrics.redness.diff.isImproved ? 'â†“' : comparisonData.metrics.redness.diff.isWorse ? 'â†‘' : 'âˆ’'}}
            </text>
            <text class="change-text">
              {{comparisonData.metrics.redness.diff.noChange ? 'æ— å˜åŒ–' : comparisonData.metrics.redness.diff.value + '%'}}
            </text>
          </view>
        </view>
        <view class="metric-bars">
          <view class="bar-group">
            <text class="bar-label">åˆå§‹</text>
            <view class="bar-container">
              <view class="bar bar-before" style="width: {{comparisonData.metrics.redness.before}}%;"></view>
            </view>
            <text class="bar-value">{{comparisonData.metrics.redness.before}}%</text>
          </view>
          <view class="bar-group">
            <text class="bar-label">å½“å‰</text>
            <view class="bar-container">
              <view class="bar bar-after" style="width: {{comparisonData.metrics.redness.after}}%;"></view>
            </view>
            <text class="bar-value">{{comparisonData.metrics.redness.after}}%</text>
          </view>
        </view>
      </view>

      <!-- è‚¿èƒ€ç¨‹åº¦ -->
      <view class="metric-item">
        <view class="metric-header">
          <text class="metric-name">è‚¿èƒ€ç¨‹åº¦</text>
          <view class="metric-change {{comparisonData.metrics.swelling.diff.isImproved ? 'improved' : comparisonData.metrics.swelling.diff.isWorse ? 'worse' : 'stable'}}">
            <text class="change-icon">
              {{comparisonData.metrics.swelling.diff.isImproved ? 'â†“' : comparisonData.metrics.swelling.diff.isWorse ? 'â†‘' : 'âˆ’'}}
            </text>
            <text class="change-text">
              {{comparisonData.metrics.swelling.diff.noChange ? 'æ— å˜åŒ–' : comparisonData.metrics.swelling.diff.value + '%'}}
            </text>
          </view>
        </view>
        <view class="metric-bars">
          <view class="bar-group">
            <text class="bar-label">åˆå§‹</text>
            <view class="bar-container">
              <view class="bar bar-before" style="width: {{comparisonData.metrics.swelling.before}}%;"></view>
            </view>
            <text class="bar-value">{{comparisonData.metrics.swelling.before}}%</text>
          </view>
          <view class="bar-group">
            <text class="bar-label">å½“å‰</text>
            <view class="bar-container">
              <view class="bar bar-after" style="width: {{comparisonData.metrics.swelling.after}}%;"></view>
            </view>
            <text class="bar-value">{{comparisonData.metrics.swelling.after}}%</text>
          </view>
        </view>
      </view>

      <!-- æ„ŸæŸ“é£é™© -->
      <view class="metric-item">
        <view class="metric-header">
          <text class="metric-name">æ„ŸæŸ“é£é™©</text>
          <view class="metric-change {{comparisonData.metrics.infection.diff.isImproved ? 'improved' : comparisonData.metrics.infection.diff.isWorse ? 'worse' : 'stable'}}">
            <text class="change-icon">
              {{comparisonData.metrics.infection.diff.isImproved ? 'â†“' : comparisonData.metrics.infection.diff.isWorse ? 'â†‘' : 'âˆ’'}}
            </text>
            <text class="change-text">
              {{comparisonData.metrics.infection.diff.noChange ? 'æ— å˜åŒ–' : comparisonData.metrics.infection.diff.value + '%'}}
            </text>
          </view>
        </view>
        <view class="metric-bars">
          <view class="bar-group">
            <text class="bar-label">åˆå§‹</text>
            <view class="bar-container">
              <view class="bar bar-before" style="width: {{comparisonData.metrics.infection.before}}%;"></view>
            </view>
            <text class="bar-value">{{comparisonData.metrics.infection.before}}%</text>
          </view>
          <view class="bar-group">
            <text class="bar-label">å½“å‰</text>
            <view class="bar-container">
              <view class="bar bar-after" style="width: {{comparisonData.metrics.infection.after}}%;"></view>
            </view>
            <text class="bar-value">{{comparisonData.metrics.infection.after}}%</text>
          </view>
        </view>
      </view>

      <!-- æ„ˆåˆç¨‹åº¦ -->
      <view class="metric-item">
        <view class="metric-header">
          <text class="metric-name">æ„ˆåˆç¨‹åº¦</text>
          <view class="metric-change {{comparisonData.metrics.healing.diff.isImproved ? 'improved' : comparisonData.metrics.healing.diff.isWorse ? 'worse' : 'stable'}}">
            <text class="change-icon">
              {{comparisonData.metrics.healing.diff.isImproved ? 'â†‘' : comparisonData.metrics.healing.diff.isWorse ? 'â†“' : 'âˆ’'}}
            </text>
            <text class="change-text">
              {{comparisonData.metrics.healing.diff.noChange ? 'æ— å˜åŒ–' : comparisonData.metrics.healing.diff.value + '%'}}
            </text>
          </view>
        </view>
        <view class="metric-bars">
          <view class="bar-group">
            <text class="bar-label">åˆå§‹</text>
            <view class="bar-container">
              <view class="bar bar-before bar-healing" style="width: {{comparisonData.metrics.healing.before}}%;"></view>
            </view>
            <text class="bar-value">{{comparisonData.metrics.healing.before}}%</text>
          </view>
          <view class="bar-group">
            <text class="bar-label">å½“å‰</text>
            <view class="bar-container">
              <view class="bar bar-after bar-healing" style="width: {{comparisonData.metrics.healing.after}}%;"></view>
            </view>
            <text class="bar-value">{{comparisonData.metrics.healing.after}}%</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æŠ¤ç†å»ºè®® -->
    <view class="comparison-section">
      <view class="section-title">
        <text class="icon">ğŸ’¡</text>
        <text class="text">æŠ¤ç†å»ºè®®</text>
      </view>
      <view class="suggestions">
        <view class="suggestion-item" wx:if="{{comparisonData.metrics.redness.diff.isWorse}}">
          <text class="suggestion-icon">ğŸ”´</text>
          <text class="suggestion-text">çº¢è‚¿ç¨‹åº¦å¢åŠ ï¼Œå»ºè®®ä¿æŒé€ å£æ¸…æ´ï¼Œé¿å…æ‘©æ“¦</text>
        </view>
        <view class="suggestion-item" wx:if="{{comparisonData.metrics.infection.diff.isWorse}}">
          <text class="suggestion-icon">âš ï¸</text>
          <text class="suggestion-text">æ„ŸæŸ“é£é™©ä¸Šå‡ï¼Œè¯·åŠæ—¶è”ç³»æŠ¤å£«è¿›è¡Œä¸“ä¸šè¯„ä¼°</text>
        </view>
        <view class="suggestion-item" wx:if="{{comparisonData.metrics.healing.diff.isImproved}}">
          <text class="suggestion-icon">âœ…</text>
          <text class="suggestion-text">æ„ˆåˆæƒ…å†µè‰¯å¥½ï¼Œè¯·ç»§ç»­ä¿æŒå½“å‰æŠ¤ç†æ–¹æ¡ˆ</text>
        </view>
        <view class="suggestion-item" wx:if="{{comparisonData.overallAssessment.level === 'great'}}">
          <text class="suggestion-icon">ğŸ‰</text>
          <text class="suggestion-text">æ¢å¤æ•ˆæœæ˜¾è‘—ï¼Œç»§ç»­ä¿æŒç§¯æçš„æŠ¤ç†æ€åº¦</text>
        </view>
      </view>
    </view>

    <view class="bottom-safe-area"></view>
  </scroll-view>

  <!-- è¶‹åŠ¿åˆ†æå†…å®¹ -->
  <scroll-view 
    wx:if="{{activeTab === 'trend' && chartData}}"
    class="content"
    scroll-y
    enable-back-to-top
  >
    <!-- å‘¨æœŸé€‰æ‹© -->
    <view class="period-selector">
      <view 
        class="period-item {{trendPeriod === '7' ? 'active' : ''}}"
        data-period="7"
        bindtap="changeTrendPeriod"
      >
        <text>è¿‘7å¤©</text>
      </view>
      <view 
        class="period-item {{trendPeriod === '30' ? 'active' : ''}}"
        data-period="30"
        bindtap="changeTrendPeriod"
      >
        <text>è¿‘30å¤©</text>
      </view>
      <view 
        class="period-item {{trendPeriod === '90' ? 'active' : ''}}"
        data-period="90"
        bindtap="changeTrendPeriod"
      >
        <text>è¿‘90å¤©</text>
      </view>
    </view>

    <!-- è¶‹åŠ¿å›¾è¡¨ -->
    <view class="chart-section">
      <view class="chart-title">å¥åº·è¯„åˆ†è¶‹åŠ¿</view>
      <view class="chart-container">
        <!-- ç®€åŒ–çš„è¶‹åŠ¿çº¿å›¾ -->
        <view class="simple-chart">
          <view class="chart-lines">
            <view class="chart-line" wx:for="{{chartData.categories}}" wx:key="index">
              <view class="line-point" style="height: {{chartData.series[0].data[index]}}%;"></view>
              <text class="line-label">{{item}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æŒ‡æ ‡è¶‹åŠ¿ -->
    <view class="trend-metrics">
      <view class="trend-metric-item" wx:for="{{chartData.series}}" wx:key="name">
        <view class="metric-legend">
          <view class="legend-dot" style="background: {{item.color}};"></view>
          <text class="legend-name">{{item.name}}</text>
        </view>
        <view class="metric-trend">
          <view class="trend-bar" wx:for="{{item.data}}" wx:for-item="value" wx:key="*this">
            <view class="trend-point" style="height: {{value}}%; background: {{item.color}};"></view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç»Ÿè®¡æ‘˜è¦ -->
    <view class="stats-summary">
      <view class="stats-title">ç»Ÿè®¡æ‘˜è¦</view>
      <view class="stats-grid">
        <view class="stat-card">
          <text class="stat-label">è¯„ä¼°æ¬¡æ•°</text>
          <text class="stat-value">{{selectedRecords.length}}</text>
          <text class="stat-unit">æ¬¡</text>
        </view>
        <view class="stat-card">
          <text class="stat-label">å¹³å‡è¯„åˆ†</text>
          <text class="stat-value">{{comparisonData.record2.score}}</text>
          <text class="stat-unit">åˆ†</text>
        </view>
        <view class="stat-card">
          <text class="stat-label">æ”¹å–„å¹…åº¦</text>
          <text class="stat-value">
            {{comparisonData.scoreDiff.isImproved ? '+' : comparisonData.scoreDiff.isWorse ? '-' : ''}}{{comparisonData.scoreDiff.value}}
          </text>
          <text class="stat-unit">%</text>
        </view>
      </view>
    </view>

    <view class="bottom-safe-area"></view>
  </scroll-view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:if="{{!comparisonData && !chartData}}" class="empty-state">
    <text class="empty-icon">ğŸ“Š</text>
    <text class="empty-text">æš‚æ— å¯¹æ¯”æ•°æ®</text>
    <text class="empty-tip">è¯·è‡³å°‘é€‰æ‹©2æ¡è¯„ä¼°è®°å½•è¿›è¡Œå¯¹æ¯”</text>
    <view class="empty-action" bindtap="goBack">
      <text>è¿”å›å†å²è®°å½•</text>
    </view>
  </view>
</view>


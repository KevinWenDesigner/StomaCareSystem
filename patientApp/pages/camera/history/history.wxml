<!--patient-app/pages/camera/history/history.wxml-->
<wxs module="utils" src="./history.wxs"></wxs>
<view class="container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <text class="page-title">å†å²è¯„ä¼°è®°å½•</text>
    <text class="page-subtitle">æŸ¥çœ‹æ‚¨çš„æ‰€æœ‰AIè¯„ä¼°è®°å½•</text>
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="action-bar">
    <button class="action-btn primary" bindtap="toggleCompareMode">
      {{compareMode ? 'å–æ¶ˆå¯¹æ¯”' : 'å¯¹æ¯”è¯„ä¼°'}}
    </button>
    <button class="action-btn" bindtap="exportRecords">
      å¯¼å‡ºè®°å½•
    </button>
    <button class="action-btn danger" bindtap="clearAllRecords">
      æ¸…ç©ºè®°å½•
    </button>
  </view>

  <!-- å¯¹æ¯”æ¨¡å¼æç¤ºå’Œæ“ä½œæ  -->
  <view wx:if="{{compareMode}}" class="compare-bar">
    <view class="compare-info">
      <text class="info-text" user-select="false">å·²é€‰ {{selectedRecords.length}} æ¡è®°å½• (éœ€2~5æ¡)</text>
    </view>
    <button 
      class="compare-btn {{selectedRecords.length >= 2 ? 'active' : 'disabled'}}"
      bindtap="startCompare"
      disabled="{{selectedRecords.length < 2}}"
    >
      å¼€å§‹å¯¹æ¯”
    </button>
  </view>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view class="stats-section">
    <view class="stats-card">
      <view class="stats-item">
        <text class="stats-number" user-select="true">{{historyList.length}}</text>
        <text class="stats-label">æ€»è®°å½•æ•°</text>
      </view>
      <view class="stats-item">
        <text class="stats-number" user-select="true">{{averageScore}}</text>
        <text class="stats-label">å¹³å‡è¯„åˆ†</text>
      </view>
      <view class="stats-item">
        <text class="stats-number" user-select="true">{{latestRecord}}</text>
        <text class="stats-label">æœ€è¿‘è¯„ä¼°</text>
      </view>
    </view>
  </view>

  <!-- è¶‹åŠ¿å›¾è¡¨ -->
  <view wx:if="{{historyList.length > 0}}" class="chart-section">
    <view class="chart-card">
      <view class="chart-header">
        <text class="chart-title">DET è¯„åˆ†è¶‹åŠ¿</text>
        <text class="chart-subtitle">æŸ¥çœ‹æ‚¨çš„è¯„ä¼°å†å²è¶‹åŠ¿</text>
      </view>
      
      <!-- å›¾ä¾‹ -->
      <view class="chart-legend">
        <view class="legend-item">
          <view class="legend-color" style="background: #ff6b6b;"></view>
          <text class="legend-text">D (å˜è‰²)</text>
        </view>
        <view class="legend-item">
          <view class="legend-color" style="background: #4ecdc4;"></view>
          <text class="legend-text">E (ä¾µèš€)</text>
        </view>
        <view class="legend-item">
          <view class="legend-color" style="background: #ffe66d;"></view>
          <text class="legend-text">T (ç»„ç»‡å¢ç”Ÿ)</text>
        </view>
        <view class="legend-item">
          <view class="legend-color" style="background: #667eea;"></view>
          <text class="legend-text">æ€»åˆ†</text>
        </view>
      </view>

      <!-- Canvas å›¾è¡¨ -->
      <view class="chart-container">
        <canvas 
          type="2d"
          id="trendChart"
          class="chart-canvas"
          style="width: 710rpx; height: 400rpx;"
          disable-scroll="true"
        ></canvas>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-section">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:elif="{{!loading && historyList.length === 0}}" class="empty-state">
    <text class="empty-icon">ğŸ“Š</text>
    <text class="empty-text">æš‚æ— è¯„ä¼°è®°å½•</text>
    <text class="empty-subtext">å¼€å§‹æ‹ç…§è¯„ä¼°ï¼Œè®°å½•æ‚¨çš„é€ å£çŠ¶æ€</text>
    <button class="empty-btn" bindtap="goToCamera">
      <text class="btn-text">å¼€å§‹è¯„ä¼°</text>
    </button>
  </view>

  <!-- å†å²è®°å½•åˆ—è¡¨ -->
  <view wx:elif="{{!loading && historyList.length > 0}}" class="history-list">
    <view wx:for="{{historyList}}" wx:key="id" class="history-item">
      <view class="history-card {{compareMode ? 'compare-mode' : ''}} {{utils.includes(selectedIds, item.id) ? 'card-selected' : ''}}" bindtap="viewDetail" data-id="{{item.id}}">
        <!-- å¯¹æ¯”æ¨¡å¼é€‰æ‹©æ¡† -->
        <view 
          wx:if="{{compareMode}}"
          class="select-checkbox {{utils.includes(selectedIds, item.id) ? 'selected' : ''}}"
          catchtap="toggleSelectRecord"
          data-id="{{item.id}}"
        >
          <view class="checkbox-icon">
            {{utils.includes(selectedIds, item.id) ? 'âœ“' : ''}}
          </view>
        </view>

        <!-- ç…§ç‰‡é¢„è§ˆ -->
        <view class="history-image-container">
          <image src="{{item.photoPath}}" mode="aspectFill" class="history-image" binderror="onImageError" data-id="{{item.id}}"></image>                                                                      
          <view class="image-overlay" wx:if="{{!compareMode}}">
            <text class="overlay-text">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</text>
          </view>
          <view class="image-overlay compare-overlay" wx:if="{{compareMode}}">
            <text class="overlay-text">{{utils.includes(selectedIds, item.id) ? 'å·²é€‰ä¸­' : 'ç‚¹å‡»é€‰æ‹©'}}</text>
          </view>
        </view>
        
        <!-- è®°å½•ä¿¡æ¯ -->
        <view class="history-content">
          <view class="history-header">
            <text class="history-time" user-select="true">{{item.time}}</text>
            <view class="history-score score-{{item.level}}">
              <text class="score-text" wx:if="{{item.rawData && item.rawData.detScore}}">{{item.rawData.detScore.total}}åˆ†</text>
              <text class="score-text" wx:else>{{item.score}}åˆ†</text>
              <text class="score-subtitle" wx:if="{{item.rawData && item.rawData.detScore}}">DET</text>
            </view>
          </view>
          
          <view class="history-details">
            <view class="detail-row">
              <text class="detail-label">è¯„ä¼°ç­‰çº§</text>
              <text class="detail-value" user-select="true">{{item.levelText}}</text>
            </view>
            <view class="detail-row">
              <text class="detail-label">è¯„ä¼°æè¿°</text>
              <text class="detail-value description" user-select="true">{{item.description}}</text>
            </view>
          </view>
        </view>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <view class="history-actions">
          <button class="action-icon-btn" catchtap="shareRecord" data-id="{{item.id}}">
            <text class="icon-text">ğŸ“¤</text>
          </button>
          <button class="action-icon-btn danger" catchtap="deleteRecord" data-id="{{item.id}}">
            <text class="icon-text">ğŸ—‘ï¸</text>
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view wx:if="{{historyList.length > 0 && hasMore}}" class="load-more">
    <text class="load-more-text">ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
  </view>

  <!-- åº•éƒ¨æç¤º -->
  <view wx:if="{{historyList.length > 0}}" class="bottom-tip">
    <text class="tip-text">å…±{{historyList.length}}æ¡è¯„ä¼°è®°å½•</text>
  </view>
</view> 